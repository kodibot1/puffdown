<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0D1117">
  <title>PuffDown</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <style>
    :root {
      --bg: #0D1117;
      --card: #161B22;
      --card-border: #21262D;
      --primary: #2DD4BF;
      --primary-dim: rgba(45,212,191,0.12);
      --mint: #86EFAC;
      --mint-dim: rgba(134,239,172,0.12);
      --gold: #FBBF24;
      --gold-dim: rgba(251,191,36,0.12);
      --coral: #F87171;
      --coral-dim: rgba(248,113,113,0.12);
      --text: #FFFFFF;
      --subtext: #9CA3AF;
      --dark-grey: #6B7280;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'SF Pro Rounded', 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      overscroll-behavior: none;
      user-select: none;
      -webkit-user-select: none;
      line-height: 1.3;
    }
    .screen {
      position: fixed; inset: 0;
      display: flex; flex-direction: column;
      padding: calc(var(--safe-top) + 16px) 20px calc(var(--safe-bottom) + 24px);
      animation: slideInRight 0.3s ease-out;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(40px); }
      to { opacity: 1; transform: translateX(0); }
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes countPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    @keyframes popIn {
      0% { transform: scale(0.8); opacity: 0; }
      60% { transform: scale(1.05); }
      100% { transform: scale(1); opacity: 1; }
    }

    /* Progress bar (green gradient, Clear30-inspired) */
    .progress-bar-container {
      width: 100%; height: 6px;
      background: var(--card-border); border-radius: 3px;
      margin-bottom: 32px;
    }
    .progress-bar-fill {
      height: 100%; border-radius: 3px;
      background: linear-gradient(90deg, #2DD4BF, #86EFAC);
      transition: width 0.4s ease;
    }

    /* Buttons */
    .btn {
      width: 100%; height: 56px;
      border: none; border-radius: 16px;
      font-family: inherit;
      font-size: 17px; font-weight: 600;
      cursor: pointer; transition: all 0.2s;
      display: flex; align-items: center; justify-content: center;
      -webkit-tap-highlight-color: transparent;
    }
    .btn-primary {
      background: var(--primary); color: #FFFFFF;
    }
    .btn-primary:active { transform: scale(0.97); opacity: 0.9; }
    .btn-primary:disabled {
      background: var(--card-border); color: var(--dark-grey);
      cursor: default; transform: none;
    }
    .btn-outline {
      background: transparent; color: var(--primary);
      border: 1.5px solid var(--primary);
    }
    .btn-outline:active { background: var(--primary-dim); }

    /* Cards */
    .card {
      background: var(--card); border: 1px solid var(--card-border);
      border-radius: 16px; padding: 16px;
    }
    .option-card {
      background: var(--card); border: 1.5px solid var(--card-border);
      border-radius: 14px; padding: 16px 18px;
      cursor: pointer; transition: all 0.15s;
      -webkit-tap-highlight-color: transparent;
      display: flex; align-items: center; gap: 14px;
    }
    .option-card:active { transform: scale(0.98); }
    .option-card.selected {
      border-color: var(--primary);
      border-width: 2px;
      background: var(--primary-dim);
    }
    .option-card.selected .label { color: var(--primary); }
    .option-card .emoji { font-size: 28px; flex-shrink: 0; }
    .option-card .label {
      font-size: 15px; font-weight: 500;
      transition: color 0.15s;
    }

    /* Multi-select card (allows up to 3) */
    .multi-select-card {
      background: var(--card); border: 1.5px solid var(--card-border);
      border-radius: 14px; padding: 14px 16px;
      cursor: pointer; transition: all 0.15s;
      -webkit-tap-highlight-color: transparent;
      display: flex; align-items: center; gap: 12px;
    }
    .multi-select-card:active { transform: scale(0.98); }
    .multi-select-card.selected {
      border-color: var(--primary);
      border-width: 2px;
      background: var(--primary-dim);
    }
    .multi-select-card .ms-check {
      width: 24px; height: 24px; border-radius: 8px;
      border: 2px solid var(--card-border);
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0; transition: all 0.15s;
      font-size: 13px; color: transparent;
    }
    .multi-select-card.selected .ms-check {
      background: var(--primary); border-color: var(--primary);
      color: #fff;
    }
    .multi-select-card .emoji { font-size: 24px; flex-shrink: 0; }
    .multi-select-card .label { font-size: 15px; font-weight: 500; }
    .multi-select-card.selected .label { color: var(--primary); }

    /* Option grid (2x2) */
    .option-grid {
      display: grid; grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .option-grid .option-card {
      flex-direction: column; text-align: center;
      padding: 20px 12px; gap: 10px;
      min-height: 52px;
    }
    .option-grid .option-card .emoji { font-size: 36px; }

    /* Option stack */
    .option-stack { display: flex; flex-direction: column; gap: 12px; }

    /* Multi-select grid */
    .multi-select-grid {
      display: grid; grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .multi-select-grid .multi-select-card {
      flex-direction: column; text-align: center;
      padding: 16px 10px; gap: 8px;
    }
    .multi-select-grid .multi-select-card .ms-check {
      position: absolute; top: 8px; right: 8px;
      width: 20px; height: 20px; border-radius: 6px;
    }
    .multi-select-grid .multi-select-card {
      position: relative;
    }
    .multi-select-grid .multi-select-card .emoji { font-size: 28px; }
    .multi-select-grid .multi-select-card .label { font-size: 13px; }

    /* Name input */
    .name-input {
      width: 100%; height: 56px;
      background: var(--card); border: 1.5px solid var(--card-border);
      border-radius: 16px; padding: 0 20px;
      font-family: inherit; font-size: 17px; font-weight: 500;
      color: var(--text); outline: none;
      transition: border-color 0.2s;
    }
    .name-input::placeholder { color: var(--dark-grey); }
    .name-input:focus { border-color: var(--primary); }

    /* Range slider */
    input[type="range"] {
      -webkit-appearance: none; width: 100%; height: 6px;
      background: var(--card-border); border-radius: 3px; outline: none;
      margin: 20px 0;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none; width: 28px; height: 28px;
      background: var(--primary); border-radius: 50%;
      cursor: pointer; border: 3px solid var(--bg);
      box-shadow: 0 0 12px rgba(45,212,191,0.35);
    }
    input[type="range"]::-moz-range-thumb {
      width: 28px; height: 28px;
      background: var(--primary); border-radius: 50%;
      cursor: pointer; border: 3px solid var(--bg);
    }

    /* Emoji slider (life impact) */
    .emoji-slider-face {
      font-size: 64px; text-align: center;
      transition: all 0.2s;
    }
    .emoji-slider-labels {
      display: flex; justify-content: space-between;
      font-size: 13px; color: var(--subtext);
    }

    /* Snapshot visualization bars */
    .snapshot-bar-container {
      margin-bottom: 20px;
    }
    .snapshot-bar-label {
      display: flex; justify-content: space-between;
      align-items: center; margin-bottom: 8px;
    }
    .snapshot-bar-label .bar-title {
      font-size: 14px; font-weight: 600;
    }
    .snapshot-bar-label .bar-value {
      font-size: 14px; font-weight: 700;
    }
    .snapshot-bar {
      width: 100%; height: 12px;
      background: var(--card-border); border-radius: 6px;
      overflow: hidden;
    }
    .snapshot-bar-fill {
      height: 100%; border-radius: 6px;
      transition: width 1.2s ease-out;
    }
    .snapshot-bar-fill.red { background: linear-gradient(90deg, #F87171, #EF4444); }
    .snapshot-bar-fill.orange { background: linear-gradient(90deg, #FBBF24, #F59E0B); }
    .snapshot-bar-fill.green { background: linear-gradient(90deg, #2DD4BF, #86EFAC); }

    /* Comparison bars */
    .comparison-bar-wrapper {
      margin-bottom: 16px;
    }
    .comparison-bar-label {
      font-size: 14px; font-weight: 500; margin-bottom: 6px;
      display: flex; align-items: center; gap: 8px;
    }
    .comparison-bar-track {
      width: 100%; height: 28px;
      background: var(--card-border); border-radius: 14px;
      overflow: hidden; position: relative;
    }
    .comparison-bar-value {
      height: 100%; border-radius: 14px;
      display: flex; align-items: center;
      padding: 0 12px; font-size: 12px; font-weight: 700;
      transition: width 1.2s ease-out;
      min-width: 40px;
    }
    .comparison-bar-value.green { background: linear-gradient(90deg, #2DD4BF, #86EFAC); color: #0D1117; }
    .comparison-bar-value.red { background: linear-gradient(90deg, #F87171, #EF4444); color: #fff; }

    /* Green gradient background for transition screens */
    .screen-gradient {
      background: linear-gradient(180deg, rgba(45,212,191,0.08) 0%, var(--bg) 60%);
    }

    /* Progress ring (SVG) */
    .progress-ring-container {
      position: relative; width: 200px; height: 200px;
      margin: 0 auto;
    }
    .progress-ring-container svg { width: 100%; height: 100%; transform: rotate(-90deg); }
    .progress-ring-bg { fill: none; stroke: var(--card-border); stroke-width: 8; }
    .progress-ring-fill {
      fill: none; stroke: var(--primary); stroke-width: 8;
      stroke-linecap: round;
      transition: stroke-dashoffset 0.8s ease-in-out;
    }
    .progress-ring-text {
      position: absolute; inset: 0;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
    }

    /* Stat boxes */
    .stat-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    .stat-box {
      background: var(--card); border: 1px solid var(--card-border);
      border-radius: 16px; padding: 14px 10px; text-align: center;
    }
    .stat-box .stat-value {
      font-size: 22px; font-weight: 700; color: var(--primary);
    }
    .stat-box .stat-label {
      font-size: 11px; color: var(--subtext); margin-top: 4px;
      text-transform: uppercase; letter-spacing: 0.5px;
      font-weight: 500;
    }

    /* Paywall pricing cards */
    .pricing-card {
      background: var(--card); border: 1.5px solid var(--card-border);
      border-radius: 16px; padding: 20px;
      cursor: pointer; transition: all 0.15s;
      position: relative; text-align: center;
    }
    .pricing-card:active { transform: scale(0.98); }
    .pricing-card.selected {
      border-color: var(--primary);
      border-width: 2px;
    }
    .pricing-card .badge {
      position: absolute; top: -11px; left: 50%; transform: translateX(-50%);
      background: var(--primary); color: var(--bg);
      font-size: 11px; font-weight: 700; padding: 3px 12px;
      border-radius: 8px; text-transform: uppercase;
      white-space: nowrap;
    }
    .pricing-card .badge-gold {
      background: var(--gold); color: var(--bg);
    }
    .pricing-card .plan-name {
      font-size: 14px; color: var(--subtext); margin-bottom: 6px;
    }
    .pricing-card .plan-price {
      font-size: 28px; font-weight: 700;
    }
    .pricing-card .plan-period {
      font-size: 13px; color: var(--subtext);
    }

    /* Feature row */
    .feature-row {
      display: flex; align-items: center; gap: 14px;
      padding: 14px 0;
    }
    .feature-row + .feature-row { border-top: 1px solid var(--card-border); }
    .feature-check {
      width: 28px; height: 28px; border-radius: 50%;
      background: var(--mint-dim);
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0; color: var(--mint); font-size: 14px; font-weight: 700;
    }

    /* Step circles (how it works) */
    .step-item {
      display: flex; gap: 16px; align-items: flex-start;
      opacity: 0; animation: fadeInUp 0.4s ease-out forwards;
    }
    .step-item:nth-child(1) { animation-delay: 0.1s; }
    .step-item:nth-child(2) { animation-delay: 0.3s; }
    .step-item:nth-child(3) { animation-delay: 0.5s; }
    .step-circle {
      width: 40px; height: 40px; border-radius: 50%;
      background: var(--primary-dim); border: 1.5px solid var(--primary);
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; color: var(--primary); flex-shrink: 0;
      font-size: 16px;
    }

    /* Goal chip (for personalized screens) */
    .goal-chip {
      display: inline-flex; align-items: center; gap: 8px;
      background: var(--primary-dim); border: 1px solid rgba(45,212,191,0.2);
      border-radius: 12px; padding: 10px 16px;
      font-size: 14px; font-weight: 500; color: var(--primary);
    }

    /* Links */
    .link-muted {
      color: var(--dark-grey); font-size: 13px;
      font-family: inherit;
      text-decoration: none; cursor: pointer;
      background: none; border: none;
      -webkit-tap-highlight-color: transparent;
    }
    .link-muted:active { opacity: 0.6; }

    /* Spacer helpers */
    .spacer { flex: 1; }
    .mb-8 { margin-bottom: 8px; }
    .mb-12 { margin-bottom: 12px; }
    .mb-16 { margin-bottom: 16px; }
    .mb-20 { margin-bottom: 20px; }
    .mb-24 { margin-bottom: 24px; }
    .mb-32 { margin-bottom: 32px; }
    .mt-auto { margin-top: auto; }
    .text-center { text-align: center; }
    .text-muted { color: var(--subtext); }
    .text-primary { color: var(--primary); }

    /* Tab bar */
    .tab-bar {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: var(--card);
      border-top: 1px solid var(--card-border);
      display: flex; justify-content: space-around;
      padding: 8px 0 calc(var(--safe-bottom) + 8px);
      z-index: 100;
    }
    .tab-item {
      display: flex; flex-direction: column; align-items: center;
      gap: 4px; padding: 4px 16px;
      background: none; border: none; cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      font-family: inherit;
    }
    .tab-item .tab-icon { font-size: 22px; line-height: 1; }
    .tab-item .tab-label {
      font-size: 10px; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.5px;
      color: var(--dark-grey); transition: color 0.15s;
    }
    .tab-item.active .tab-label { color: var(--primary); }

    /* Floating puff button (FAB) */
    .puff-fab {
      position: fixed;
      bottom: calc(70px + var(--safe-bottom) + 16px);
      right: 20px;
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: var(--primary);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 20px rgba(45, 212, 191, 0.4);
      z-index: 99;
      -webkit-tap-highlight-color: transparent;
      transition: transform 0.15s, box-shadow 0.3s;
    }
    .puff-fab:active {
      transform: scale(0.9);
    }
    .puff-fab.bumped {
      animation: fabBump 0.3s ease;
    }
    @keyframes fabBump {
      0% { transform: scale(1); }
      40% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
    .puff-fab svg {
      width: 30px;
      height: 30px;
    }
    .puff-fab.over-target {
      background: var(--coral);
      box-shadow: 0 4px 20px rgba(248, 113, 113, 0.4);
    }
    .puff-fab-toast {
      position: fixed;
      bottom: calc(70px + var(--safe-bottom) + 90px);
      right: 20px;
      background: var(--card);
      border: 1px solid rgba(45, 212, 191, 0.3);
      border-radius: 12px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 600;
      color: var(--primary);
      z-index: 99;
      opacity: 0;
      transform: translateY(8px);
      transition: all 0.3s ease;
      pointer-events: none;
      white-space: nowrap;
    }
    .puff-fab-toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    /* Main app screen with tab bar */
    .screen-with-tabs {
      position: fixed; inset: 0;
      display: flex; flex-direction: column;
      padding: calc(var(--safe-top) + 24px) 20px 0;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    .tab-content {
      flex: 1; padding-bottom: calc(70px + var(--safe-bottom));
    }

    /* Timeline milestone cards */
    .milestone-card {
      background: var(--card); border: 1px solid var(--card-border);
      border-radius: 16px; padding: 16px;
      display: flex; align-items: center; gap: 14px;
      margin-bottom: 12px; transition: opacity 0.2s;
    }
    .milestone-card.achieved { border-color: rgba(134,239,172,0.3); }
    .milestone-card.next { border-color: var(--gold); }
    .milestone-card.future { opacity: 0.5; }
    .milestone-icon {
      width: 44px; height: 44px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 20px; flex-shrink: 0;
    }
    .milestone-card.achieved .milestone-icon { background: var(--mint-dim); }
    .milestone-card.next .milestone-icon { background: var(--gold-dim); }
    .milestone-card.future .milestone-icon { background: var(--card-border); }
    .milestone-badge {
      font-size: 10px; font-weight: 700; text-transform: uppercase;
      letter-spacing: 0.5px; padding: 2px 8px; border-radius: 6px;
      display: inline-block; margin-top: 4px;
    }
    .milestone-card.achieved .milestone-badge { background: var(--mint-dim); color: var(--mint); }
    .milestone-card.next .milestone-badge { background: var(--gold-dim); color: var(--gold); }

    /* Learn fact cards */
    .fact-card {
      background: var(--card); border: 1px solid var(--card-border);
      border-radius: 16px; padding: 20px;
      margin-bottom: 12px;
    }
    .fact-card .fact-emoji {
      font-size: 32px; margin-bottom: 10px; display: block;
    }
    .fact-card .fact-title {
      font-size: 16px; font-weight: 600; margin-bottom: 6px;
    }
    .fact-card .fact-body {
      font-size: 14px; color: var(--subtext); line-height: 1.5;
    }

    /* Daily fact card */
    .daily-fact {
      background: linear-gradient(135deg, rgba(45,212,191,0.08), rgba(134,239,172,0.08));
      border: 1px solid rgba(45,212,191,0.2);
      border-radius: 16px; padding: 16px;
    }

    /* Mock notification */
    .mock-notif {
      background: #1C1C1E; border-radius: 16px; padding: 14px 16px;
      display: flex; align-items: flex-start; gap: 12px;
      border: 1px solid rgba(255,255,255,0.08);
    }
    .mock-notif-icon {
      width: 36px; height: 36px; border-radius: 10px;
      background: var(--primary-dim);
      display: flex; align-items: center; justify-content: center;
      font-size: 18px; flex-shrink: 0;
    }
    .mock-notif-title { font-size: 14px; font-weight: 600; margin-bottom: 2px; }
    .mock-notif-body { font-size: 13px; color: var(--subtext); }
    .mock-notif-time { font-size: 11px; color: var(--dark-grey); margin-left: auto; flex-shrink: 0; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    // ‚îÄ‚îÄ Storage helpers ‚îÄ‚îÄ
    const STORAGE_KEY = 'puffdown_data';
    function loadData() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : null;
      } catch { return null; }
    }
    function saveData(d) {
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); } catch {}
    }

    // ‚îÄ‚îÄ Count-up animation hook ‚îÄ‚îÄ
    function useCountUp(target, duration = 1500, delay = 0) {
      const [value, setValue] = useState(0);

      useEffect(() => {
        let start = null;
        let animId;
        const timeout = setTimeout(() => {
          const step = (ts) => {
            if (!start) start = ts;
            const elapsed = ts - start;
            const progress = Math.min(elapsed / duration, 1);
            const eased = 1 - Math.pow(1 - progress, 3);
            setValue(Math.round(target * eased));
            if (progress < 1) {
              animId = requestAnimationFrame(step);
            }
          };
          animId = requestAnimationFrame(step);
        }, delay);

        return () => {
          clearTimeout(timeout);
          if (animId) cancelAnimationFrame(animId);
        };
      }, [target, duration, delay]);

      return value;
    }

    // ‚îÄ‚îÄ Spend ranges ‚Üí midpoint weekly $ (legacy migration) ‚îÄ‚îÄ
    const SPEND_MAP = {
      under_15: 10,
      '15_30': 22.5,
      '30_50': 40,
      '50_plus': 65
    };

    // ‚îÄ‚îÄ Get weekly spend as a number (handles old string format + new number format) ‚îÄ‚îÄ
    function getWeeklySpendNum(weeklySpend) {
      if (typeof weeklySpend === 'number') return weeklySpend;
      if (typeof weeklySpend === 'string') return SPEND_MAP[weeklySpend] || 22.5;
      return 22.5;
    }

    // ‚îÄ‚îÄ Progress bar (pure component) ‚îÄ‚îÄ
    function ProgressBar({ current, total }) {
      const pct = Math.round((current / total) * 100);
      return (
        <div className="progress-bar-container">
          <div className="progress-bar-fill" style={{ width: pct + '%' }} />
        </div>
      );
    }

    // ‚îÄ‚îÄ Goal emoji map ‚îÄ‚îÄ
    const GOAL_EMOJIS = {
      'Breathe easier': 'ü´Å',
      'Save money': 'üí∞',
      'Break the addiction': 'üí™',
      'Mental clarity': 'üß†',
      'Better fitness': 'üèÉ',
      'Improve relationships': '‚ù§Ô∏è',
      'Feel in control': 'üéØ',
      'Better sleep': 'üò¥'
    };

    // ‚îÄ‚îÄ Health recovery timeline ‚îÄ‚îÄ
    const HEALTH_TIMELINE = [
      { time: '20 min', minutes: 20, title: 'Heart rate normalizes', desc: 'Your heart rate and blood pressure begin to drop back to normal levels.', emoji: '‚ù§Ô∏è' },
      { time: '8 hours', minutes: 480, title: 'Oxygen levels recover', desc: 'Carbon monoxide levels in your blood drop. Oxygen levels return to normal.', emoji: 'ü´Å' },
      { time: '24 hours', minutes: 1440, title: 'Heart attack risk drops', desc: 'Your risk of a heart attack begins to decrease as your cardiovascular system starts healing.', emoji: 'üí™' },
      { time: '48 hours', minutes: 2880, title: 'Taste & smell return', desc: 'Nerve endings start regrowing. Your sense of taste and smell begin to sharpen.', emoji: 'üëÉ' },
      { time: '72 hours', minutes: 4320, title: 'Breathing gets easier', desc: 'Bronchial tubes relax and lung capacity starts to increase. Breathing feels easier.', emoji: 'üå¨Ô∏è' },
      { time: '2 weeks', minutes: 20160, title: 'Circulation improves', desc: 'Blood flow improves throughout your body. Walking and exercise become easier.', emoji: 'üèÉ' },
      { time: '1 month', minutes: 43200, title: 'Immune system strengthens', desc: 'Your immune system begins to recover. You get sick less often.', emoji: 'üõ°Ô∏è' },
      { time: '3 months', minutes: 129600, title: 'Lung function up 30%', desc: 'Your lung function has significantly improved. Coughing and shortness of breath decrease.', emoji: 'üìà' },
      { time: '1 year', minutes: 525600, title: 'Heart disease risk halved', desc: 'Your risk of coronary heart disease is now half that of a vaper. A massive milestone.', emoji: 'üèÜ' }
    ];

    // ‚îÄ‚îÄ Vape education facts ‚îÄ‚îÄ
    const VAPE_FACTS = [
      { emoji: 'üß™', title: 'What\'s in vape juice?', body: 'Vape liquid contains propylene glycol, vegetable glycerin, nicotine, and flavoring chemicals. When heated, these produce formaldehyde, acrolein, and heavy metals like lead and nickel ‚Äî none of which belong in your lungs.' },
      { emoji: 'üß†', title: 'Nicotine & your brain', body: 'A single JUUL pod contains as much nicotine as 20 cigarettes. Nicotine rewires your brain\'s reward system, making it harder to feel pleasure from everyday activities. Young brains are especially vulnerable.' },
      { emoji: 'ü´Å', title: 'Popcorn lung risk', body: 'Diacetyl, a flavoring chemical found in many vape juices, is linked to bronchiolitis obliterans ("popcorn lung") ‚Äî a serious, irreversible condition that scars the tiny air sacs in your lungs.' },
      { emoji: '‚ù§Ô∏è', title: 'Heart damage', body: 'Nicotine raises blood pressure, spikes adrenaline, and increases heart rate. Studies show vaping just once can stiffen arteries. Long-term use significantly raises the risk of heart attack and stroke.' },
      { emoji: 'üõ°Ô∏è', title: 'Weakened immunity', body: 'Vaping suppresses the immune response in your nasal passages and lungs. Regular vapers are more susceptible to respiratory infections, including flu and pneumonia.' },
      { emoji: 'üß¨', title: 'DNA damage', body: 'Research has found that e-cigarette vapor damages DNA in the mouth, lungs, and bladder. DNA damage is the first step toward cancer. The longer you vape, the more damage accumulates.' },
      { emoji: 'üí®', title: 'Secondhand vapor', body: 'Exhaled vapor contains ultrafine particles, nicotine, heavy metals, and volatile organic compounds. People around you ‚Äî especially children ‚Äî breathe these in. "It\'s just water vapor" is a myth.' },
      { emoji: 'üí∞', title: 'The cost adds up', body: 'The average vaper spends $1,000‚Äì$2,500 per year. That\'s a vacation, a new phone, or months of groceries. Quitting puts real money back in your pocket ‚Äî starting on day one.' },
      { emoji: 'üò∞', title: 'Anxiety & depression link', body: 'While many vape to "relieve stress," nicotine actually increases anxiety and depression over time. The relief you feel is just the withdrawal easing temporarily ‚Äî a cycle that gets worse.' },
      { emoji: 'üò¨', title: 'Oral health damage', body: 'Vaping dries out your mouth, kills healthy bacteria, and inflames gums. This leads to cavities, gum disease, and bad breath. Some users develop painful mouth sores and cracked lips.' },
      { emoji: 'üèãÔ∏è', title: 'Fitness impact', body: 'Vaping reduces lung capacity, restricts blood flow, and increases resting heart rate. Athletes who vape notice decreased endurance, slower recovery, and increased breathlessness during exercise.' },
      { emoji: 'üò¥', title: 'Sleep disruption', body: 'Nicotine is a stimulant that disrupts your sleep cycle. Vapers take longer to fall asleep, sleep less deeply, and wake up more tired. Poor sleep worsens mood, focus, and cravings.' }
    ];

    // ‚îÄ‚îÄ Daily tips / facts (rotates by day of year) ‚îÄ‚îÄ
    const DAILY_FACTS = [
      'Every puff you skip is a win. Your body starts healing within 20 minutes of your last hit.',
      'Nicotine cravings peak at 3-5 minutes. Distract yourself and they pass.',
      'A JUUL pod has as much nicotine as 20 cigarettes. Each puff down is progress.',
      'Your lungs start clearing mucus within 72 hours of reducing intake.',
      'Vaping can deliver heavy metals like lead directly to your lungs.',
      'Quitting saves the average vaper over $1,500 per year.',
      'Nicotine narrows your blood vessels, reducing oxygen to every organ.',
      'Your sense of taste and smell start improving within 48 hours.',
      'Exercise is one of the most effective craving-busters. Even a short walk helps.',
      'Vaping before bed disrupts deep sleep. Better sleep starts when you quit.',
      'Formaldehyde ‚Äî yes, embalming fluid ‚Äî is produced when vape juice is heated.',
      'Your heart rate begins normalizing just 20 minutes after your last puff.',
      'Diacetyl in vape flavors is linked to irreversible lung damage.',
      'Drinking water helps flush nicotine from your system faster.',
      'Stress relief from vaping is an illusion ‚Äî nicotine actually increases anxiety long-term.'
    ];

    // ‚îÄ‚îÄ Notification messages ‚îÄ‚îÄ
    const NOTIF_MESSAGES = [
      { title: 'How are you doing?', body: 'Tap to log a puff and stay on track.' },
      { title: 'Stay strong!', body: 'Every puff you skip is healing your body.' },
      { title: 'Check in time', body: 'Log your puffs to keep your streak going.' },
      { title: 'You\'re doing great', body: 'Tap to update your progress for today.' },
      { title: 'Quick check-in', body: 'How\'s your day going? Tap to log.' },
      { title: 'Keep it up!', body: 'Your lungs are thanking you. Tap to log.' },
      { title: 'Reminder', body: 'Don\'t forget to track ‚Äî awareness is power.' }
    ];

    // ‚îÄ‚îÄ Onboarding total screens (0-20), main app = 21 ‚îÄ‚îÄ
    const TOTAL_ONBOARDING_SCREENS = 26;

    // ‚îÄ‚îÄ App ‚îÄ‚îÄ
    function App() {
      const saved = loadData();
      const [screen, setScreen] = useState(
        saved && saved.onboardingComplete ? TOTAL_ONBOARDING_SCREENS : 0
      );
      const [data, setData] = useState({
        userName: '',
        goals: [],
        longTermGoal: null,
        vapeType: null,
        dailyPuffs: 150,
        vapingDuration: null,
        weeklySpend: 30,
        spendPeriod: 'every2weeks',
        spendRaw: 40,
        lifeImpact: 3,
        triggers: [],
        biggestStruggle: null,
        quitAttempts: null,
        onboardingComplete: false,
        isPremium: false,
        ...(saved || {})
      });

      useEffect(() => { saveData(data); }, [data]);

      const update = (key, val) => setData(prev => ({ ...prev, [key]: val }));
      const next = () => setScreen(s => s + 1);

      // Helper: toggle item in array (max items)
      const toggleArrayItem = (key, item, max) => {
        setData(prev => {
          const arr = prev[key] || [];
          if (arr.includes(item)) {
            return { ...prev, [key]: arr.filter(x => x !== item) };
          }
          if (arr.length >= max) return prev;
          return { ...prev, [key]: [...arr, item] };
        });
      };

      // Helper: display name or fallback
      const displayName = data.userName ? data.userName.split(' ')[0] : '';

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // PHASE 1: PINPOINT THE PROBLEM (0-10)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    // ‚îÄ‚îÄ Screen 0: Welcome ‚îÄ‚îÄ
      function WelcomeScreen() {
        const [localName, setLocalName] = useState(data.userName);
        const handleContinue = () => {
          update('userName', localName);
          next();
        };
        return (
          <div className="screen" key="s0">
            <div className="spacer" />
            <div className="text-center mb-32">
              <div style={{ fontSize: 80, marginBottom: 24 }}>ü´Å</div>
              <h1 style={{ fontSize: 28, fontWeight: 700, marginBottom: 12, lineHeight: 1.1 }}>
                Ready to quit vaping?
              </h1>
              <p className="text-muted" style={{ fontSize: 15, lineHeight: 1.4, marginBottom: 32 }}>
                Let's build a plan that actually works for you
              </p>
              <input
                className="name-input"
                type="text"
                placeholder="What's your name?"
                value={localName}
                onChange={e => setLocalName(e.target.value)}
                autoFocus
              />
            </div>
            <div className="spacer" />
            <button className="btn btn-primary" onClick={handleContinue} disabled={!localName.trim()}>
              Let's Go
            </button>
          </div>
        );
      }

    // ‚îÄ‚îÄ Screen 1: Goals (multi-select, up to 3) ‚îÄ‚îÄ
      function GoalsScreen() {
        const options = [
          'Breathe easier', 'Save money', 'Break the addiction', 'Mental clarity',
          'Better fitness', 'Improve relationships', 'Feel in control', 'Better sleep'
        ];
        return (
          <div className="screen" key="s1">
            <ProgressBar current={1} total={25} />
            <h2 style={{ fontSize: 22, fontWeight: 600, marginBottom: 6 }}>What do you want to achieve?</h2>
            <p className="text-muted mb-24" style={{ fontSize: 14 }}>
              So tell us {displayName}, what matters most? <span style={{ color: 'var(--dark-grey)', fontSize: 12 }}>(pick up to 3)</span>
            </p>
            <div className="multi-select-grid mb-24">
              {options.map(opt => (
                <div
                  key={opt}
                  className={`multi-select-card ${(data.goals || []).includes(opt) ? 'selected' : ''}`}
                  onClick={() => toggleArrayItem('goals', opt, 3)}
                >
                  <div className="ms-check">‚úì</div>
                  <span className="emoji">{GOAL_EMOJIS[opt]}</span>
                  <span className="label">{opt}</span>
                </div>
              ))}
            </div>
            <div className="spacer" />
            <button className="btn btn-primary" onClick={next} disabled={!(data.goals && data.goals.length > 0)}>
              That's Me
            </button>
          </div>
        );
      }

      // ‚îÄ‚îÄ Screen 2: Goals Reflection (Clear30-inspired) ‚îÄ‚îÄ
      function GoalsReflectionScreen() {
        const goalReflections = {
          'Breathe easier': { desc: 'Your lungs will thank you within days.', stat: '87% feel easier breathing in 30 days' },
          'Save money': { desc: `That's $${Math.round(getWeeklySpendNum(data.weeklySpend) * 52)} back in your pocket this year.`, stat: '94% save more than expected' },
          'Break the addiction': { desc: "Nicotine doesn't own you. Let's prove it.", stat: '79% break the daily habit within 45 days' },
          'Mental clarity': { desc: 'The fog lifts faster than you think.', stat: '81% report improved mental clarity' },
          'Better fitness': { desc: 'Your body is ready to bounce back.', stat: '85% see fitness gains within weeks' },
          'Improve relationships': { desc: 'Be fully present with the people you love.', stat: '76% report stronger relationships' },
          'Feel in control': { desc: "You're taking the wheel back.", stat: '92% feel more in control after 2 weeks' },
          'Better sleep': { desc: 'Deep, restful sleep is closer than you think.', stat: '88% sleep better within the first week' }
        };
        return (
          <div className="screen screen-gradient" key="s2">
            <ProgressBar current={2} total={25} />
            <div className="text-center mb-20">
              <h2 style={{ fontSize: 22, fontWeight: 600, marginBottom: 6 }}>
                Great choices, {displayName}
              </h2>
              <p className="text-muted" style={{ fontSize: 14 }}>Here's what we'll focus on together</p>
            </div>

            {(data.goals || []).map((g, i) => {
              const ref = goalReflections[g];
              if (!ref) return null;
              return (
                <div key={g} className="card mb-12" style={{
                  padding: 16, borderColor: 'rgba(45,212,191,0.15)',
                  animation: `fadeInUp 0.4s ease-out ${i * 0.15}s both`
                }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: 10, marginBottom: 6 }}>
                    <span style={{ fontSize: 22 }}>{GOAL_EMOJIS[g]}</span>
                    <span style={{ fontSize: 16, fontWeight: 600 }}>{g}</span>
                  </div>
                  <p style={{ fontSize: 14, color: 'var(--subtext)', lineHeight: 1.4, marginBottom: 6 }}>{ref.desc}</p>
                  <p style={{ fontSize: 13, color: 'var(--primary)', fontWeight: 500 }}>{ref.stat}</p>
                </div>
              );
            })}

            <div className="card mb-24" style={{
              padding: 14, textAlign: 'center', marginTop: 8,
              background: 'linear-gradient(135deg, rgba(45,212,191,0.06), rgba(134,239,172,0.06))',
              borderColor: 'rgba(134,239,172,0.2)'
            }}>
              <p style={{ fontSize: 14, color: 'var(--subtext)', lineHeight: 1.4 }}>
                You're in the right place. Thousands started with the same goals and got there with PuffDown.
              </p>
            </div>

            <div className="spacer" />
            <button className="btn btn-primary" onClick={next}>Let's Keep Going</button>
          </div>
        );
      }

      // ‚îÄ‚îÄ Screen 3: Long-term Goal (single select) ‚îÄ‚îÄ
      function LongTermGoalScreen() {
        const options = [
          { key: 'quit', label: 'Quit vaping completely', emoji: 'üö´' },
          { key: 'cut_down', label: 'Cut down significantly', emoji: 'üìâ' },
          { key: '30_day_break', label: 'Take a 30-day break', emoji: 'üìÖ' },
          { key: 'track', label: 'Just track and see', emoji: 'üìä' }
        ];
        return (
          <div className="screen" key="s2">
            <ProgressBar current={2} total={25} />
            <h2 style={{ fontSize: 22, fontWeight: 600, marginBottom: 6 }}>What's your long-term goal?</h2>
            <p className="text-muted mb-24" style={{ fontSize: 14 }}>
              Got it {displayName}! Now where do you see yourself headed?
            </p>
            <div className="option-stack mb-32">
              {options.map(o => (
                <div
                  key={o.key}
                  className={`option-card ${data.longTermGoal === o.key ? 'selected' : ''}`}
                  onClick={() => update('longTermGoal', o.key)}
                >
                  <span className="emoji">{o.emoji}</span>
                  <span className="label">{o.label}</span>
                </div>
              ))}
            </div>
            <div className="spacer" />
            <button className="btn btn-primary" onClick={next} disabled={!data.longTermGoal}>
              That's the Plan
            </button>
          </div>
        );
      }

      // ‚îÄ‚îÄ Screen 4: Vape Type ‚îÄ‚îÄ
      function VapeTypeScreen() {
        const types = [
          { key: 'disposable', emoji: 'üåÄ', label: 'Disposable' },
          { key: 'pod', emoji: 'üí®', label: 'Pod System' },
          { key: 'mod', emoji: 'üîã', label: 'Box Mod' },
          { key: 'multiple', emoji: 'üîÄ', label: 'Multiple Devices' }
        ];
        return (
          <div className="screen" key="s3">
            <ProgressBar current={3} total={25} />
            <h2 style={{ fontSize: 22, fontWeight: 600, marginBottom: 6 }}>What do you vape?</h2>
            <p className="text-muted mb-24" style={{ fontSize: 14 }}>This helps us understand your usage pattern.</p>
            <div className="option-grid mb-32">
              {types.map(t => (
                <div
                  key={t.key}
                  className={`option-card ${data.vapeType === t.key ? 'selected' : ''}`}
                  onClick={() => update('vapeType', t.key)}
                >
                  <span className="emoji">{t.emoji}</span>
                  <span className="label">{t.label}</span>
                </div>
              ))}
            </div>
            <div className="spacer" />
            <button className="btn btn-primary" onClick={next} disabled={!data.vapeType}>
              Continue
            </button>
          </div>
        );
      }

      // ‚îÄ‚îÄ Screen 5: Daily Puffs (slider) ‚îÄ‚îÄ
      function DailyPuffsScreen() {
        return (
          <div className="screen" key="s4">
            <ProgressBar current={4} total={25} />
            <h2 style={{ fontSize: 22, fontWeight: 600, marginBottom: 6 }}>How many puffs per day?</h2>
            <p className="text-muted mb-32" style={{ fontSize: 14 }}>Now, let's understand your use a bit more.</p>
            <div className="text-center mb-16">
              <span style={{ fontSize: 56, fontWeight: 700, color: 'var(--primary)' }}>
                {data.dailyPuffs}
              </span>
              <br />
              <span className="text-muted" style={{ fontSize: 15 }}>puffs per day</span>
            </div>
            <input
              type="range"
              min={10} max={500} step={10}
              value={data.dailyPuffs}
              onChange={e => update('dailyPuffs', Number(e.target.value))}
            />
            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 16 }}>
              <span className="text-muted" style={{ fontSize: 13 }}>10</span>
              <span className="text-muted" style={{ fontSize: 13 }}>500</span>
            </div>
            <p className="text-muted text-center mb-32" style={{ fontSize: 13 }}>
              {data.dailyPuffs < 50 ? 'Light use ‚Äî great starting point' :
               data.dailyPuffs < 150 ? 'Moderate use ‚Äî very manageable' :
               data.dailyPuffs < 300 ? 'Heavy use ‚Äî we\'ve helped thousands like you' :
               'Very heavy use ‚Äî your plan will be extra gradual'}
            </p>
            <div className="spacer" />
            <button className="btn btn-primary" onClick={next}>Got It</button>
          </div>
        );
      }

      // ‚îÄ‚îÄ Screen 6: Vaping Duration (single select) ‚îÄ‚îÄ
      function VapingDurationScreen() {
        const options = [
          { key: 'under_6mo', label: 'Less than 6 months', emoji: 'üå±' },
          { key: '6_12mo', label: '6‚Äì12 months', emoji: 'üìÖ' },
          { key: '1_2yr', label: '1‚Äì2 years', emoji: '‚è≥' },
          { key: '2_5yr', label: '2‚Äì5 years', emoji: 'üìÜ' },
          { key: '5plus', label: '5+ years', emoji: 'üîí' }
        ];
        return (
          <div className="screen" key="s5">
            <ProgressBar current={5} total={25} />
            <h2 style={{ fontSize: 22, fontWeight: 600, marginBottom: 6 }}>How long have you been vaping?</h2>
            <p className="text-muted mb-24" style={{ fontSize: 14 }}>This helps us tailor your quit timeline.</p>
            <div className="option-stack mb-32">
              {options.map(o => (
                <div
                  key={o.key}
                  className={`option-card ${data.vapingDuration === o.key ? 'selected' : ''}`}
                  onClick={() => update('vapingDuration', o.key)}
                >
                  <span className="emoji">{o.emoji}</span>
                  <span className="label">{o.label}</span>
                </div>
              ))}
            </div>
            <div className="spacer" />
            <button className="btn btn-primary" onClick={next} disabled={!data.vapingDuration}>
              Continue
            </button>
          </div>
        );
      }

      // ‚îÄ‚îÄ Screen 7: Spend (slider with period toggle) ‚îÄ‚îÄ
      function WeeklySpendScreen() {
        const [period, setPeriod] = useState(data.spendPeriod || 'every2weeks');
        const spend = typeof data.weeklySpend === 'number' ? data.weeklySpend : 30;

        const periodConfig = {
          week: { label: 'Weekly', min: 5, max: 100, step: 5, toWeekly: v => v },
          every2weeks: { label: 'Every 2 weeks', min: 10, max: 150, step: 5, toWeekly: v => Math.round(v / 2) },
          month: { label: 'Monthly', min: 15, max: 300, step: 5, toWeekly: v => Math.round(v / 4.33) }
        };
        const cfg = periodConfig[period];
        const rawSpend = data.spendRaw || (period === 'every2weeks' ? spend * 2 : period === 'month' ? Math.round(spend * 4.33) : spend);
        const weeklyCalc = cfg.toWeekly(rawSpend);
        const clampedRaw = Math.max(cfg.min, Math.min(cfg.max, rawSpend));

        const handlePeriodChange = (newPeriod) => {
          setPeriod(newPeriod);
          update('spendPeriod', newPeriod);
          // Reset raw spend to a reasonable default for the new period
          const defaults = { week: 25, every2weeks: 40, month: 100 };
          const newRaw = defaults[newPeriod];
          setData(prev => ({ ...prev, spendRaw: newRaw, weeklySpend: periodConfig[newPeriod].toWeekly(newRaw) }));
        };

        const handleSlide = (val) => {
          const num = Number(val);
          setData(prev => ({ ...prev, spendRaw: num, weeklySpend: cfg.toWeekly(num) }));
        };

        return (
          <div className="screen" key="s6">
            <ProgressBar current={6} total={25} />
            <h2 style={{ fontSize: 22, fontWeight: 600, marginBottom: 6 }}>How much do you spend on vaping?</h2>
            <p className="text-muted mb-24" style={{ fontSize: 14 }}>We use this to calculate your savings.</p>

            <div style={{ display: 'flex', gap: 8, marginBottom: 24 }}>
              {Object.entries(periodConfig).map(([key, val]) => (
                <button
                  key={key}
                  onClick={() => handlePeriodChange(key)}
                  style={{
                    flex: 1, padding: '10px 4px', borderRadius: 12,
                    border: period === key ? '2px solid var(--primary)' : '1.5px solid var(--card-border)',
                    background: period === key ? 'var(--primary-dim)' : 'var(--card)',
                    color: period === key ? 'var(--primary)' : 'var(--subtext)',
                    fontSize: 13, fontWeight: 600, fontFamily: 'inherit', cursor: 'pointer'
                  }}
                >{val.label}</button>
              ))}
            </div>

            <div className="text-center mb-16">
              <span style={{ fontSize: 56, fontWeight: 700, color: 'var(--gold)' }}>
                ${clampedRaw}
              </span>
              <br />
              <span className="text-muted" style={{ fontSize: 15 }}>
                {period === 'week' ? 'per week' : period === 'every2weeks' ? 'every 2 weeks' : 'per month'}
              </span>
            </div>
            <input
              type="range"
              min={cfg.min} max={cfg.max} step={cfg.step}
              value={clampedRaw}
              onChange={e => handleSlide(e.target.value)}
            />
            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 16 }}>
              <span className="text-muted" style={{ fontSize: 13 }}>${cfg.min}</span>
              <span className="text-muted" style={{ fontSize: 13 }}>${cfg.max}</span>
            </div>
            <p className="text-muted text-center mb-32" style={{ fontSize: 13 }}>
              That's <span style={{ color: 'var(--gold)', fontWeight: 600 }}>${weeklyCalc * 52}</span> per year
            </p>
            <div className="spacer" />
            <button className="btn btn-primary" onClick={next}>Next</button>
          </div>
        );
      }

      // ‚îÄ‚îÄ Screen 8: Life Impact (emoji slider) ‚îÄ‚îÄ
      function LifeImpactScreen() {
        const faces = ['üò´', 'üòü', 'üòê', 'üôÇ', 'üòÑ'];
        const labels = ['Seriously harming', 'Somewhat harming', 'Neutral', 'Somewhat helping', 'Helping'];
        const impact = data.lifeImpact || 3;
        return (
          <div className="screen" key="s7">
            <ProgressBar current={7} total={25} />
            <h2 style={{ fontSize: 22, fontWeight: 600, marginBottom: 6 }}>How is vaping affecting your life?</h2>
            <p className="text-muted mb-32" style={{ fontSize: 14 }}>Be honest ‚Äî there's no wrong answer.</p>
            <div className="text-center mb-16">
              <div className="emoji-slider-face" key={impact}
                style={{ animation: 'popIn 0.3s ease-out' }}>
                {faces[impact - 1]}
              </div>
              <p style={{ fontSize: 16, fontWeight: 500, marginTop: 8, color: impact <= 2 ? 'var(--coral)' : impact >= 4 ? 'var(--mint)' : 'var(--subtext)' }}>
                {labels[impact - 1]}
              </p>
            </div>
            <input
              type="range"
              min={1} max={5} step={1}
              value={impact}
              onChange={e => update('lifeImpact', Number(e.target.value))}
              style={{
                background: `linear-gradient(90deg, var(--coral) 0%, var(--gold) 50%, var(--mint) 100%)`
              }}
            />
            <div className="emoji-slider-labels mb-32">
              <span>Harming</span>
              <span>Helping</span>
            </div>
            <div className="spacer" />
            <button className="btn btn-primary" onClick={next}>I See It</button>
          </div>
        );
      }

      // ‚îÄ‚îÄ Screen 9: Triggers (multi-select, up to 3) ‚îÄ‚îÄ
      function TriggersScreen() {
        const options = [
          { label: 'First thing in the morning', emoji: 'üåÖ' },
          { label: 'After meals', emoji: 'üçΩÔ∏è' },
          { label: 'When stressed', emoji: 'üò∞' },
          { label: 'When bored', emoji: 'üòë' },
          { label: 'While driving', emoji: 'üöó' },
          { label: 'Social situations', emoji: 'üë•' },
          { label: 'Before bed', emoji: 'üåô' },
          { label: 'While working', emoji: 'üíª' }
        ];
        return (
          <div className="screen" key="s8">
            <ProgressBar current={8} total={25} />
            <h2 style={{ fontSize: 22, fontWeight: 600, marginBottom: 6 }}>When do you vape most?</h2>
            <p className="text-muted mb-24" style={{ fontSize: 14 }}>
              To help us create a plan for when temptations arise. <span style={{ color: 'var(--dark-grey)', fontSize: 12 }}>(pick up to 3)</span>
            </p>
            <div className="multi-select-grid mb-24">
              {options.map(o => (
                <div
                  key={o.label}
                  className={`multi-select-card ${(data.triggers || []).includes(o.label) ? 'selected' : ''}`}
                  onClick={() => toggleArrayItem('triggers', o.label, 3)}
                >
                  <div className="ms-check">‚úì</div>
                  <span className="emoji">{o.emoji}</span>
                  <span className="label">{o.label}</span>
                </div>
              ))}
            </div>
            <div className="spacer" />
            <button className="btn btn-primary" onClick={next} disabled={!(data.triggers && data.triggers.length > 0)}>
              I See the Pattern
            </button>
          </div>
        );
      }

      // ‚îÄ‚îÄ Screen 10: Biggest Struggle ‚îÄ‚îÄ
      function BiggestStruggleScreen() {
        const options = [
          { key: 'cravings', label: 'Cravings are intense', emoji: 'üß†' },
          { key: 'habit', label: 'It\'s just a habit', emoji: 'üîÅ' },
          { key: 'social', label: 'Social pressure', emoji: 'üë•' },
          { key: 'stress', label: 'Stress relief', emoji: 'üò§' }
        ];
        return (
          <div className="screen" key="s9">
            <ProgressBar current={9} total={25} />
            <h2 style={{ fontSize: 22, fontWeight: 600, marginBottom: 6 }}>What's your biggest struggle?</h2>
            <p className="text-muted mb-24" style={{ fontSize: 14 }}>Understanding this helps us support you better.</p>
            <div className="option-stack mb-32">
              {options.map(o => (
                <div
                  key={o.key}
                  className={`option-card ${data.biggestStruggle === o.key ? 'selected' : ''}`}
                  onClick={() => update('biggestStruggle', o.key)}
                >
                  <span className="emoji">{o.emoji}</span>
                  <span className="label">{o.label}</span>
                </div>
              ))}
            </div>
            <div className="spacer" />
            <button className="btn btn-primary" onClick={next} disabled={!data.biggestStruggle}>
              Continue
            </button>
          </div>
        );
      }

      // ‚îÄ‚îÄ Screen 11: Quit Attempts ‚îÄ‚îÄ
      function QuitAttemptsScreen() {
        const options = [
          { key: 'many', label: 'Yes, many times', emoji: 'üîÑ' },
          { key: 'few', label: 'Yes, once or twice', emoji: '‚úåÔ∏è' },
          { key: 'first', label: 'No, this is my first try', emoji: 'üåü' }
        ];
        return (
          <div className="screen" key="s10">
            <ProgressBar current={10} total={25} />
            <h2 style={{ fontSize: 22, fontWeight: 600, marginBottom: 6 }}>Have you tried to quit before?</h2>
            <p className="text-muted mb-24" style={{ fontSize: 14 }}>This helps us build on what you already know.</p>
            <div className="option-stack mb-32">
              {options.map(o => (
                <div
                  key={o.key}
                  className={`option-card ${data.quitAttempts === o.key ? 'selected' : ''}`}
                  onClick={() => update('quitAttempts', o.key)}
                >
                  <span className="emoji">{o.emoji}</span>
                  <span className="label">{o.label}</span>
                </div>
              ))}
            </div>
            <div className="spacer" />
            <button className="btn btn-primary" onClick={next} disabled={!data.quitAttempts}>
              Continue
            </button>
          </div>
        );
      }

      // ‚îÄ‚îÄ Screen 12: Motivational Interstitial ‚îÄ‚îÄ
      function MotivationalScreen() {
        const messages = {
          many: {
            emoji: 'üí™',
            title: "You've been here before ‚Äî that's your superpower.",
            body: "Every attempt taught you something. This time you have a plan, a tracker, and a system built around your patterns. Let's make this one count."
          },
          few: {
            emoji: '‚úåÔ∏è',
            title: "You've got experience on your side.",
            body: "You already know what it takes to start. PuffDown gives you the structure to finish."
          },
          first: {
            emoji: 'üåü',
            title: "The first step takes the most courage.",
            body: "Most people never even try. You're already ahead of everyone still thinking about it."
          }
        };
        const msg = messages[data.quitAttempts] || messages.first;
        return (
          <div className="screen screen-gradient" key="s12">
            <div className="spacer" />
            <div className="text-center">
              <div style={{
                width: 80, height: 80, borderRadius: '50%',
                background: 'var(--primary-dim)',
                display: 'flex', alignItems: 'center', justifyContent: 'center',
                margin: '0 auto 24px', fontSize: 36,
                animation: 'popIn 0.5s ease-out'
              }}>{msg.emoji}</div>
              <h2 style={{ fontSize: 22, fontWeight: 700, marginBottom: 12, lineHeight: 1.3 }}>
                {msg.title}
              </h2>
              <p style={{ fontSize: 15, color: 'var(--subtext)', lineHeight: 1.5, maxWidth: 320, margin: '0 auto' }}>
                {msg.body}
              </p>
            </div>
            <div className="spacer" />
            <button className="btn btn-primary" onClick={next}>Build My Plan</button>
          </div>
        );
      }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // PHASE 2: SHOW THE SOLUTION (13-18)
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

      // ‚îÄ‚îÄ Screen 13: Analyzing Transition ‚îÄ‚îÄ
      function TransitionScreen() {
        const [step, setStep] = useState(0);
        const topGoal = (data.goals || [])[0] || 'quitting';
        const struggleMap = {
          cravings: 'managing cravings',
          habit: 'breaking the habit loop',
          social: 'handling social pressure',
          stress: 'finding better stress relief'
        };
        const struggleText = struggleMap[data.biggestStruggle] || 'your quit journey';

        // Goal-specific personalized messages
        const goalInsights = {
          'Breathe easier': 'Your lungs will start clearing within 72 hours',
          'Save money': `You could save $${Math.round(getWeeklySpendNum(data.weeklySpend) * 52)} this year`,
          'Break the addiction': 'Most cravings last only 3-5 minutes ‚Äî we\'ll help you through each one',
          'Mental clarity': 'Nicotine fog lifts within the first week',
          'Better fitness': 'Lung capacity improves 30% within 3 months',
          'Improve relationships': 'No more sneaking away or worrying about the smell',
          'Feel in control': 'Tracking puts you back in the driver\'s seat',
          'Better sleep': 'Without nicotine, deep sleep returns within days'
        };

        const steps = [
          { text: `Analyzing your ${data.dailyPuffs} puffs/day pattern...`, delay: 800 },
          { text: `Building a plan for ${struggleText}...`, delay: 1600 },
          { text: `Personalizing for "${topGoal}"...`, delay: 2400 }
        ];

        useEffect(() => {
          const timers = steps.map((s, i) =>
            setTimeout(() => setStep(i + 1), s.delay)
          );
          const done = setTimeout(() => setStep(4), 3400);
          return () => { timers.forEach(clearTimeout); clearTimeout(done); };
        }, []);

        return (
          <div className="screen screen-gradient" key="s11">
            <div className="spacer" />
            <div className="text-center mb-32">
              {step < 4 ? (
                <div style={{ animation: 'fadeInUp 0.5s ease-out' }}>
                  <div style={{
                    width: 64, height: 64, margin: '0 auto 24px',
                    border: '3px solid var(--card-border)', borderTop: '3px solid var(--primary)',
                    borderRadius: '50%', animation: 'spin 1s linear infinite'
                  }} />
                  <style>{`@keyframes spin { to { transform: rotate(360deg); } }`}</style>
                  {steps.map((s, i) => (
                    <p key={i} style={{
                      fontSize: 15, color: step > i ? 'var(--primary)' : 'var(--dark-grey)',
                      marginBottom: 8, transition: 'color 0.3s',
                      opacity: step > i ? 1 : 0.4
                    }}>
                      {step > i ? '‚úì ' : ''}{s.text}
                    </p>
                  ))}
                </div>
              ) : (
                <div style={{ animation: 'fadeInUp 0.4s ease-out' }}>
                  <h2 style={{ fontSize: 26, fontWeight: 700, marginBottom: 16, lineHeight: 1.2 }}>
                    We hear you, {displayName}.
                  </h2>
                  <p style={{ fontSize: 16, lineHeight: 1.5, color: 'var(--subtext)', marginBottom: 20 }}>
                    You want to <span style={{ color: 'var(--primary)', fontWeight: 600 }}>{topGoal.toLowerCase()}</span> and
                    your biggest challenge is <span style={{ color: 'var(--primary)', fontWeight: 600 }}>{struggleText}</span>.
                  </p>
                  {(data.goals || []).slice(0, 2).map(g => goalInsights[g] && (
                    <div key={g} className="card mb-12" style={{ padding: 14, textAlign: 'left', borderColor: 'rgba(45,212,191,0.2)' }}>
                      <p style={{ fontSize: 14, lineHeight: 1.4 }}>
                        <span style={{ marginRight: 8 }}>{GOAL_EMOJIS[g]}</span>
                        <span style={{ color: 'var(--subtext)' }}>{goalInsights[g]}</span>
                      </p>
                    </div>
                  ))}
                </div>
              )}
            </div>
            <div className="spacer" />
            {step >= 4 && (
              <button className="btn btn-primary" onClick={next} style={{ animation: 'fadeInUp 0.3s ease-out' }}>
                See My Results
              </button>
            )}
          </div>
        );
      }

      // ‚îÄ‚îÄ Screen 14: Personalized Snapshot (Circular Gauges) ‚îÄ‚îÄ
      function SnapshotScreen() {
        const weeklySpendNum = getWeeklySpendNum(data.weeklySpend);
        const yearlySpend = Math.round(weeklySpendNum * 52);

        const durationMultiplier = {
          'under_6mo': 0.5, '6_12mo': 0.7, '1_2yr': 0.85, '2_5yr': 0.95, '5plus': 1.0
        };
        const durMult = durationMultiplier[data.vapingDuration] || 0.7;
        const puffScore = Math.min(data.dailyPuffs / 500, 1);
        const nicotineDep = Math.round((puffScore * 0.6 + durMult * 0.4) * 100);

        const triggerCount = (data.triggers || []).length;
        const habitStrength = Math.round((triggerCount / 3 * 0.5 + durMult * 0.5) * 100);

        const [show, setShow] = useState(false);
        useEffect(() => { const t = setTimeout(() => setShow(true), 300); return () => clearTimeout(t); }, []);

        // Circular gauge component
        function Gauge({ value, max, color, label, sublabel, size }) {
          const s = size || 100;
          const r = (s - 12) / 2;
          const circ = 2 * Math.PI * r;
          const pct = Math.min(value / max, 1);
          return (
            <div style={{ textAlign: 'center' }}>
              <div style={{ position: 'relative', width: s, height: s, margin: '0 auto' }}>
                <svg width={s} height={s} style={{ transform: 'rotate(-90deg)' }}>
                  <circle cx={s/2} cy={s/2} r={r} fill="none" stroke="var(--card-border)" strokeWidth="8" />
                  <circle cx={s/2} cy={s/2} r={r} fill="none" stroke={color} strokeWidth="8"
                    strokeLinecap="round" strokeDasharray={circ}
                    strokeDashoffset={show ? circ * (1 - pct) : circ}
                    style={{ transition: 'stroke-dashoffset 1.2s ease-out' }} />
                </svg>
                <div style={{
                  position: 'absolute', inset: 0, display: 'flex',
                  alignItems: 'center', justifyContent: 'center',
                  flexDirection: 'column'
                }}>
                  <span style={{ fontSize: 22, fontWeight: 700, color }}>{value}%</span>
                </div>
              </div>
              <p style={{ fontSize: 13, fontWeight: 600, marginTop: 8 }}>{label}</p>
              <p style={{ fontSize: 11, color: 'var(--subtext)', marginTop: 2 }}>{sublabel}</p>
            </div>
          );
        }

        return (
          <div className="screen" key="s12">
            <ProgressBar current={12} total={25} />
            <h2 style={{ fontSize: 22, fontWeight: 600, marginBottom: 6 }}>Your Vaping Snapshot</h2>
            <p className="text-muted mb-32" style={{ fontSize: 14 }}>Here's what your answers tell us, {displayName}.</p>

            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 20, marginBottom: 24 }}>
              <Gauge value={nicotineDep} max={100} color="var(--coral)" label="Dependency" sublabel="Nicotine level" />
              <Gauge value={habitStrength} max={100} color="var(--gold)" label="Habit Strength" sublabel="Pattern depth" />
            </div>

            <div className="card mb-24" style={{ padding: 16, textAlign: 'center' }}>
              <p style={{ fontSize: 13, color: 'var(--subtext)', textTransform: 'uppercase', letterSpacing: 0.5, fontWeight: 600, marginBottom: 4 }}>
                Financial drain
              </p>
              <p style={{ fontSize: 32, fontWeight: 700, color: 'var(--gold)' }}>${yearlySpend}</p>
              <p style={{ fontSize: 14, color: 'var(--subtext)' }}>spent on vaping this year</p>
            </div>

            <div className="spacer" />
            <button className="btn btn-primary" onClick={next}>Show Me More</button>
          </div>
        );
      }

      // ‚îÄ‚îÄ Screen 15: Social Proof ‚îÄ‚îÄ
      function SocialProofScreen() {
        return (
          <div className="screen screen-gradient" key="s15">
            <ProgressBar current={15} total={25} />
            <div className="text-center mb-24">
              <h2 style={{ fontSize: 22, fontWeight: 600, marginBottom: 6 }}>
                You're not doing this alone
              </h2>
              <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 8, marginTop: 12 }}>
                <span style={{ width: 8, height: 8, borderRadius: '50%', background: 'var(--mint)', display: 'inline-block' }} />
                <span style={{ fontSize: 28, fontWeight: 700, color: 'var(--primary)' }}>12,000+</span>
              </div>
              <p className="text-muted" style={{ fontSize: 14, marginTop: 4 }}>people are quitting with PuffDown</p>
            </div>

            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12, marginBottom: 24 }}>
              <div className="card" style={{ textAlign: 'center', padding: 16 }}>
                <p style={{ fontSize: 28, fontWeight: 700, color: 'var(--primary)', marginBottom: 4 }}>87%</p>
                <p style={{ fontSize: 12, color: 'var(--subtext)', lineHeight: 1.3 }}>reduce puffs in the first week</p>
              </div>
              <div className="card" style={{ textAlign: 'center', padding: 16 }}>
                <p style={{ fontSize: 28, fontWeight: 700, color: 'var(--mint)', marginBottom: 4 }}>92%</p>
                <p style={{ fontSize: 12, color: 'var(--subtext)', lineHeight: 1.3 }}>feel more in control after 2 weeks</p>
              </div>
            </div>

            <div className="card mb-24" style={{
              padding: 16, borderColor: 'rgba(45,212,191,0.2)',
              background: 'linear-gradient(135deg, rgba(45,212,191,0.04), rgba(134,239,172,0.04))'
            }}>
              <p style={{ fontSize: 14, fontStyle: 'italic', color: 'var(--subtext)', lineHeight: 1.5, marginBottom: 8 }}>
                "I actually did it. 45 days without vaping. I was doing a pod a day and honestly didn't think I could stop. PuffDown made it feel possible."
              </p>
              <p style={{ fontSize: 13, fontWeight: 600, color: 'var(--primary)' }}>‚Äî Alex, 23</p>
            </div>

            <div style={{ display: 'flex', justifyContent: 'center', gap: 4, marginBottom: 8 }}>
              {[1,2,3,4,5].map(i => (
                <span key={i} style={{ fontSize: 18, color: 'var(--gold)' }}>‚òÖ</span>
              ))}
            </div>
            <p className="text-muted text-center mb-24" style={{ fontSize: 13 }}>4.8 average rating</p>

            <div className="spacer" />
            <button className="btn btn-primary" onClick={next}>I'm Next</button>
          </div>
        );
      }

      // ‚îÄ‚îÄ Screen 16: You Now vs You in 45 Days (Comparison) ‚îÄ‚îÄ
      function ComparisonScreen() {
        const weeklySpendNum = getWeeklySpendNum(data.weeklySpend);
        const savingsIn45 = Math.round(weeklySpendNum * 6.5);
        const topGoal = (data.goals || [])[0] || 'Better health';

        // Goal-specific future benefits
        const futureBenefits = {
          'Breathe easier': { now: 'Reduced lung capacity', future: 'Lungs clearing, breathing deeper', emoji: 'ü´Å' },
          'Save money': { now: `Spending $${Math.round(weeklySpendNum)}/week`, future: `$${savingsIn45} back in your pocket`, emoji: 'üí∞' },
          'Break the addiction': { now: 'Nicotine controls your day', future: 'You control your choices', emoji: 'üí™' },
          'Mental clarity': { now: 'Brain fog from nicotine cycles', future: 'Clear head, sharper focus', emoji: 'üß†' },
          'Better fitness': { now: 'Low stamina, heavy breathing', future: '30% more lung capacity', emoji: 'üèÉ' },
          'Improve relationships': { now: 'Sneaking hits, hiding habits', future: 'Present and honest', emoji: '‚ù§Ô∏è' },
          'Feel in control': { now: 'Cravings dictate your schedule', future: 'You decide, not nicotine', emoji: 'üéØ' },
          'Better sleep': { now: 'Restless, nicotine-disrupted sleep', future: 'Deep, restorative rest', emoji: 'üò¥' }
        };

        const goals = (data.goals || []).slice(0, 3);
        const [show, setShow] = useState(false);
        useEffect(() => { const t = setTimeout(() => setShow(true), 300); return () => clearTimeout(t); }, []);

        return (
          <div className="screen" key="s13">
            <ProgressBar current={13} total={25} />
            <h2 style={{ fontSize: 22, fontWeight: 600, marginBottom: 6 }}>Your Transformation</h2>
            <p className="text-muted mb-24" style={{ fontSize: 14 }}>What 45 days of PuffDown looks like for you.</p>

            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 0, marginBottom: 24 }}>
              <div style={{ textAlign: 'center', padding: '12px 8px' }}>
                <p style={{ fontSize: 12, fontWeight: 700, textTransform: 'uppercase', letterSpacing: 0.5, color: 'var(--coral)', marginBottom: 12 }}>You Now</p>
              </div>
              <div style={{ textAlign: 'center', padding: '12px 8px' }}>
                <p style={{ fontSize: 12, fontWeight: 700, textTransform: 'uppercase', letterSpacing: 0.5, color: 'var(--mint)', marginBottom: 12 }}>You in 45 Days</p>
              </div>
            </div>

            {goals.map((g, i) => {
              const benefit = futureBenefits[g] || { now: 'Current habits', future: 'Healthier you', emoji: '‚ú®' };
              return (
                <div key={g} className="card mb-12" style={{
                  padding: 14, opacity: show ? 1 : 0,
                  transform: show ? 'translateY(0)' : 'translateY(16px)',
                  transition: `all 0.5s ease-out ${i * 0.2}s`
                }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: 10, marginBottom: 8 }}>
                    <span style={{ fontSize: 20 }}>{benefit.emoji}</span>
                    <span style={{ fontSize: 14, fontWeight: 600 }}>{g}</span>
                  </div>
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr auto 1fr', gap: 8, alignItems: 'center' }}>
                    <p style={{ fontSize: 13, color: 'var(--coral)', lineHeight: 1.3 }}>{benefit.now}</p>
                    <span style={{ fontSize: 18, color: 'var(--dark-grey)' }}>‚Üí</span>
                    <p style={{ fontSize: 13, color: 'var(--mint)', fontWeight: 500, lineHeight: 1.3 }}>{benefit.future}</p>
                  </div>
                </div>
              );
            })}

            <div className="text-center mb-16" style={{ marginTop: 16 }}>
              {data.quitAttempts === 'many' && (
                <p style={{ fontSize: 14, color: 'var(--subtext)', lineHeight: 1.4 }}>
                  You've tried before ‚Äî this time, you'll have a real plan behind you.
                </p>
              )}
              {data.quitAttempts === 'first' && (
                <p style={{ fontSize: 14, color: 'var(--subtext)', lineHeight: 1.4 }}>
                  Your first quit journey starts strong. We've got you.
                </p>
              )}
            </div>

            <div className="spacer" />
            <button className="btn btn-primary" onClick={next}>I Want This</button>
          </div>
        );
      }

      // ‚îÄ‚îÄ Screen 17: Personalized Goal Insights ‚îÄ‚îÄ
      function GoalsSolutionScreen() {
        const goalLabels = {
          quit: 'Quit completely',
          cut_down: 'Cut down significantly',
          '30_day_break': 'Take a 30-day break',
          track: 'Track and see'
        };

        // Personalized insight for each goal ‚Äî this is what makes the user feel heard
        const goalDetails = {
          'Breathe easier': { insight: 'Your lungs start healing within 72 hours. By day 30, you\'ll notice deeper breaths and less coughing.', stat: '30% lung improvement in 3 months' },
          'Save money': { insight: `At $${Math.round(getWeeklySpendNum(data.weeklySpend))}/week, that\'s real money. We\'ll track every dollar you save.`, stat: `$${Math.round(getWeeklySpendNum(data.weeklySpend) * 52)} saved per year` },
          'Break the addiction': { insight: 'Nicotine rewires your brain\'s reward system. PuffDown helps you untangle it one day at a time.', stat: 'Most cravings last only 3-5 min' },
          'Mental clarity': { insight: 'Nicotine creates a fog cycle ‚Äî hit, crash, repeat. Breaking it brings back your natural focus.', stat: 'Focus improves within 1 week' },
          'Better fitness': { insight: 'Vaping restricts blood flow and lung capacity. Athletes see gains within weeks of cutting back.', stat: 'Lung capacity +30% in 90 days' },
          'Improve relationships': { insight: 'No more stepping out to hit the vape or worrying about what people think. Be fully present.', stat: 'Relationship quality up 40%' },
          'Feel in control': { insight: 'Right now nicotine decides when you hit. Tracking flips the script ‚Äî you decide.', stat: 'Users report control within 2 weeks' },
          'Better sleep': { insight: 'Nicotine is a stimulant that fragments your sleep cycle. Without it, deep sleep returns fast.', stat: 'Sleep quality improves in 3 days' }
        };

        return (
          <div className="screen" key="s14">
            <ProgressBar current={14} total={25} />
            <div className="text-center mb-20">
              <h2 style={{ fontSize: 24, fontWeight: 700, marginBottom: 8, lineHeight: 1.2 }}>
                Here's how PuffDown helps you, {displayName}
              </h2>
              <p className="text-muted" style={{ fontSize: 14 }}>Based on your goals</p>
            </div>

            {(data.goals || []).map((g, i) => {
              const detail = goalDetails[g];
              if (!detail) return null;
              return (
                <div key={g} className="card mb-12" style={{
                  padding: 16, borderColor: 'rgba(45,212,191,0.15)',
                  animation: `fadeInUp 0.4s ease-out ${i * 0.15}s both`
                }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: 10, marginBottom: 8 }}>
                    <span style={{ fontSize: 24 }}>{GOAL_EMOJIS[g]}</span>
                    <span style={{ fontSize: 16, fontWeight: 600 }}>{g}</span>
                  </div>
                  <p style={{ fontSize: 14, color: 'var(--subtext)', lineHeight: 1.5, marginBottom: 8 }}>
                    {detail.insight}
                  </p>
                  <p style={{ fontSize: 13, color: 'var(--primary)', fontWeight: 600 }}>
                    {detail.stat}
                  </p>
                </div>
              );
            })}

            <div className="card mb-24" style={{
              padding: 14, textAlign: 'center', marginTop: 8,
              background: 'linear-gradient(135deg, rgba(45,212,191,0.06), rgba(134,239,172,0.06))',
              borderColor: 'rgba(134,239,172,0.2)'
            }}>
              <p style={{ fontSize: 14, fontWeight: 500, marginBottom: 4 }}>
                Your mission: <span style={{ color: 'var(--primary)' }}>{goalLabels[data.longTermGoal] || 'Quit vaping'}</span>
              </p>
              <p style={{ fontSize: 13, color: 'var(--subtext)' }}>
                Thousands started with the same goals and succeeded with PuffDown
              </p>
            </div>

            <div className="spacer" />
            <button className="btn btn-primary" onClick={next}>See My Plan</button>
          </div>
        );
      }

      // ‚îÄ‚îÄ Screen 18: Personalized Plan ‚îÄ‚îÄ
      function PersonalPlanScreen() {
        const weeklySpendNum = getWeeklySpendNum(data.weeklySpend);
        const savingsTarget = Math.round(weeklySpendNum * 6.5);
        const quitDate = new Date();
        quitDate.setDate(quitDate.getDate() + 45);
        const quitDateStr = quitDate.toLocaleDateString('en-US', {
          month: 'long', day: 'numeric', year: 'numeric'
        });

        const animDays = useCountUp(45, 1500, 200);
        const animSavings = useCountUp(savingsTarget, 1500, 500);

        const topGoals = (data.goals || []).slice(0, 3);

        return (
          <div className="screen" key="s15">
            <ProgressBar current={15} total={25} />
            <div className="text-center mb-24">
              <h2 style={{ fontSize: 24, fontWeight: 700, marginBottom: 4, lineHeight: 1.1 }}>
                {displayName}'s PuffDown Plan
              </h2>
              <p className="text-muted" style={{ fontSize: 14 }}>45 days from now</p>
            </div>

            <div className="card mb-12" style={{ textAlign: 'center', padding: 20 }}>
              <p className="text-muted" style={{ fontSize: 13, marginBottom: 6, textTransform: 'uppercase', letterSpacing: 0.5, fontWeight: 500 }}>
                Your target
              </p>
              <p style={{ fontSize: 48, fontWeight: 700, color: 'var(--primary)' }}>
                {animDays} <span style={{ fontSize: 22, fontWeight: 600 }}>days</span>
              </p>
              <p className="text-muted" style={{ fontSize: 13, marginTop: 4 }}>
                {quitDateStr}
              </p>
            </div>

            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12, marginBottom: 20 }}>
              <div className="card" style={{ textAlign: 'center', padding: 14 }}>
                <p className="text-muted" style={{ fontSize: 11, marginBottom: 4, textTransform: 'uppercase', letterSpacing: 0.5, fontWeight: 500 }}>
                  You'll save
                </p>
                <p style={{ fontSize: 26, fontWeight: 700, color: 'var(--gold)' }}>
                  ${animSavings}
                </p>
              </div>
              {topGoals[0] && (
                <div className="card" style={{ textAlign: 'center', padding: 14 }}>
                  <p className="text-muted" style={{ fontSize: 11, marginBottom: 4, textTransform: 'uppercase', letterSpacing: 0.5, fontWeight: 500 }}>
                    Top goal
                  </p>
                  <p style={{ fontSize: 20, marginBottom: 2 }}>{GOAL_EMOJIS[topGoals[0]]}</p>
                  <p style={{ fontSize: 13, fontWeight: 500, color: 'var(--primary)' }}>{topGoals[0]}</p>
                </div>
              )}
            </div>

            <div className="card mb-24" style={{ padding: 16 }}>
              <p style={{ fontSize: 13, fontWeight: 600, textTransform: 'uppercase', letterSpacing: 0.5, color: 'var(--primary)', marginBottom: 12 }}>
                How we'll get you there
              </p>
              <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>
                <div className="step-item">
                  <div className="step-circle">1</div>
                  <div>
                    <p style={{ fontSize: 15, fontWeight: 500 }}>Track every puff</p>
                    <p className="text-muted" style={{ fontSize: 13 }}>One tap per puff. See your real usage ‚Äî most people are shocked by the number.</p>
                  </div>
                </div>
                <div className="step-item">
                  <div className="step-circle">2</div>
                  <div>
                    <p style={{ fontSize: 15, fontWeight: 500 }}>Follow your daily target</p>
                    <p className="text-muted" style={{ fontSize: 13 }}>Your limit drops a little each day over 45 days. Small enough you won't feel it.</p>
                  </div>
                </div>
                <div className="step-item">
                  <div className="step-circle">3</div>
                  <div>
                    <p style={{ fontSize: 15, fontWeight: 500 }}>Watch the results</p>
                    <p className="text-muted" style={{ fontSize: 13 }}>Money saved, health recovering, puffs dropping. The proof keeps you going.</p>
                  </div>
                </div>
              </div>
            </div>

            <div className="spacer" />
            <button className="btn btn-primary mb-12" onClick={next}>Start my PuffDown</button>
            <div className="text-center">
              <button className="link-muted" onClick={() => {
                setData(prev => ({ ...prev, onboardingComplete: true, startDate: todayKey(), puffLogs: prev.puffLogs || {} }));
                setScreen(TOTAL_ONBOARDING_SCREENS);
              }}>I'm not ready yet</button>
            </div>
          </div>
        );
      }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // PHASE 3: WOW MOMENT (16)
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

      // ‚îÄ‚îÄ Screen 19: Interactive Day 1 Demo (Wow Moment) ‚îÄ‚îÄ
      function WowMomentScreen() {
        const [demoPuffs, setDemoPuffs] = useState(0);
        const [tapped, setTapped] = useState(false);
        const todayStr = new Date().toLocaleDateString('en-US', {
          weekday: 'long', month: 'long', day: 'numeric'
        });
        const dailyTarget = Math.max(data.dailyPuffs - 10, 1);
        const circumference = 2 * Math.PI * 88;
        const progress = Math.min(demoPuffs / dailyTarget, 1);
        const offset = circumference * (1 - progress);

        const handleTap = () => {
          setDemoPuffs(p => p + 1);
          setTapped(true);
        };

        return (
          <div className="screen" key="s16">
            <div className="text-center mb-8">
              <p className="text-muted" style={{ fontSize: 13 }}>{todayStr}</p>
              <h2 style={{ fontSize: 28, fontWeight: 700, marginTop: 4, lineHeight: 1.1 }}>Day 1</h2>
            </div>

            <div style={{ height: 12 }} />

            <div className="progress-ring-container mb-24">
              <svg viewBox="0 0 200 200">
                <circle className="progress-ring-bg" cx="100" cy="100" r="88" />
                <circle
                  className="progress-ring-fill"
                  cx="100" cy="100" r="88"
                  strokeDasharray={circumference}
                  strokeDashoffset={offset}
                />
              </svg>
              <div className="progress-ring-text">
                <span style={{
                  fontSize: 48, fontWeight: 700,
                  animation: demoPuffs > 0 ? 'countPulse 0.3s ease' : 'none'
                }} key={demoPuffs}>{demoPuffs}</span>
                <span className="text-muted" style={{ fontSize: 15 }}>/ {dailyTarget} puffs</span>
              </div>
            </div>

            <div className="stat-row mb-24">
              <div className="stat-box">
                <div className="stat-value" style={{ color: 'var(--primary)' }}>0</div>
                <div className="stat-label">Day Streak</div>
              </div>
              <div className="stat-box">
                <div className="stat-value" style={{ color: 'var(--gold)' }}>$0</div>
                <div className="stat-label">Saved</div>
              </div>
              <div className="stat-box">
                <div className="stat-value" style={{ color: 'var(--mint)' }}>ü´Å</div>
                <div className="stat-label">Recovering</div>
              </div>
            </div>

            {!tapped && (
              <button className="btn btn-primary mb-16" onClick={handleTap}
                style={{ animation: 'countPulse 2s ease-in-out infinite' }}>
                Tap to log your first puff
              </button>
            )}

            {tapped && (
              <div style={{ animation: 'fadeInUp 0.4s ease-out' }}>
                <div className="card mb-12" style={{ padding: 16, borderColor: 'rgba(45,212,191,0.3)' }}>
                  <p style={{ fontSize: 15, fontWeight: 600, color: 'var(--primary)', marginBottom: 8 }}>
                    Why this works
                  </p>
                  <p style={{ fontSize: 14, lineHeight: 1.6, color: 'var(--subtext)', marginBottom: 10 }}>
                    Most vapers hit their device <span style={{ color: '#fff', fontWeight: 600 }}>200+ times a day</span> without realizing it. Tracking makes the invisible visible.
                  </p>
                  <p style={{ fontSize: 14, lineHeight: 1.6, color: 'var(--subtext)' }}>
                    Every time you log a puff, you create a <span style={{ color: '#fff', fontWeight: 600 }}>pause moment</span> ‚Äî a split second of awareness that naturally starts reducing your usage.
                  </p>
                </div>
                <button className="btn btn-primary" onClick={next}>I'm Ready</button>
              </div>
            )}

            {tapped && (
              <button className="btn btn-outline mb-12" onClick={handleTap} style={{ marginTop: 8 }}>
                + Log another puff
              </button>
            )}

            <div className="spacer" />
          </div>
        );
      }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // PHASE 4: SOFT PAYWALL (20-24)
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

      // ‚îÄ‚îÄ Screen 20: Fair Trial Reframe ‚îÄ‚îÄ
      function FairTrialScreen() {
        const weeklySpendNum = getWeeklySpendNum(data.weeklySpend);
        return (
          <div className="screen screen-gradient" key="s20">
            <div className="spacer" />
            <div className="text-center mb-32">
              <p style={{ fontSize: 13, fontWeight: 600, color: 'var(--primary)', textTransform: 'uppercase', letterSpacing: 1, marginBottom: 16 }}>
                Fair Trial Policy
              </p>

              <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', gap: 24, marginBottom: 24 }}>
                <div style={{ textAlign: 'center' }}>
                  <div style={{
                    width: 64, height: 64, borderRadius: '50%',
                    background: 'var(--primary-dim)', display: 'flex',
                    alignItems: 'center', justifyContent: 'center',
                    margin: '0 auto 8px', fontSize: 28
                  }}>ü´Å</div>
                  <p style={{ fontSize: 13, fontWeight: 600, color: 'var(--primary)' }}>Your health back</p>
                </div>
                <span style={{ fontSize: 18, color: 'var(--dark-grey)' }}>vs</span>
                <div style={{ textAlign: 'center' }}>
                  <div style={{
                    width: 64, height: 64, borderRadius: '50%',
                    background: 'var(--coral-dim)', display: 'flex',
                    alignItems: 'center', justifyContent: 'center',
                    margin: '0 auto 8px', fontSize: 28
                  }}>üí®</div>
                  <p style={{ fontSize: 13, fontWeight: 600, color: 'var(--coral)' }}>${weeklySpendNum}/week on vaping</p>
                </div>
              </div>

              <h2 style={{ fontSize: 22, fontWeight: 700, marginBottom: 12, lineHeight: 1.3 }}>
                PuffDown is free for you to try
              </h2>
              <p style={{ fontSize: 15, color: 'var(--subtext)', lineHeight: 1.5, maxWidth: 300, margin: '0 auto' }}>
                After your trial, your support helps us keep building the best tools to help people quit vaping.
              </p>
            </div>
            <div className="spacer" />
            <button className="btn btn-primary" onClick={next}>That's Fair</button>
          </div>
        );
      }

      // ‚îÄ‚îÄ Screen 21: Paywall Step 1 (Features)  ‚îÄ‚îÄ
      function PaywallStep1Screen() {
        const features = [
          { title: 'Smart puff tracking', desc: 'Auto-adjusting daily limits that adapt to you' },
          { title: 'Progress insights', desc: 'Health recovery timeline, savings tracker & streaks' },
          { title: 'Craving support', desc: 'Techniques and tools when urges hit' }
        ];
        return (
          <div className="screen" key="s17">
            <div className="spacer" style={{ flex: 0.3 }} />
            <div className="text-center mb-32">
              <h2 style={{ fontSize: 26, fontWeight: 700, marginBottom: 8, lineHeight: 1.1 }}>
                Your plan is ready.<br />Unlock it all.
              </h2>
            </div>
            <div className="card mb-32" style={{ padding: '4px 16px' }}>
              {features.map((f, i) => (
                <div className="feature-row" key={i}>
                  <div className="feature-check">‚úì</div>
                  <div>
                    <p style={{ fontSize: 15, fontWeight: 500, marginBottom: 2 }}>{f.title}</p>
                    <p className="text-muted" style={{ fontSize: 13 }}>{f.desc}</p>
                  </div>
                </div>
              ))}
            </div>
            <div className="spacer" />
            <button className="btn btn-primary" onClick={next}>Show Me</button>
          </div>
        );
      }

      // ‚îÄ‚îÄ Screen 22: Paywall Step 2 (Trust) ‚îÄ‚îÄ
      function PaywallStep2Screen() {
        return (
          <div className="screen" key="s18">
            <div className="spacer" />
            <div className="text-center">
              <div style={{
                width: 80, height: 80, borderRadius: '50%',
                background: 'var(--primary-dim)',
                display: 'flex', alignItems: 'center', justifyContent: 'center',
                margin: '0 auto 24px', fontSize: 36
              }}>üîî</div>
              <h2 style={{ fontSize: 22, fontWeight: 600, marginBottom: 12, lineHeight: 1.3 }}>
                We'll remind you before your trial ends
              </h2>
              <p className="text-muted mb-32" style={{ fontSize: 15, lineHeight: 1.4 }}>
                You won't be charged today. Start your 7-day free trial and cancel anytime ‚Äî we'll send a reminder 24 hours before it renews.
              </p>
              <p style={{ fontSize: 14, color: 'var(--mint)', fontWeight: 600 }}>No Payment Due Now</p>
            </div>
            <div className="spacer" />
            <button className="btn btn-primary" onClick={next}>Continue for FREE</button>
          </div>
        );
      }

      // ‚îÄ‚îÄ Screen 23: Paywall Step 3 (Pricing) ‚îÄ‚îÄ
      function PaywallStep3Screen() {
        const [selectedPlan, setSelectedPlan] = useState('monthly');

        const finishOnboarding = () => {
          setData(prev => ({
            ...prev,
            onboardingComplete: true,
            startDate: prev.startDate || todayKey(),
            puffLogs: prev.puffLogs || {}
          }));
          setScreen(24); // Go to notification screen
        };

        return (
          <div className="screen" key="s19">
            <div className="spacer" style={{ flex: 0.2 }} />
            <div className="text-center mb-24">
              <h2 style={{ fontSize: 28, fontWeight: 700, marginBottom: 8, lineHeight: 1.1 }}>Choose your plan</h2>
              <p className="text-muted" style={{ fontSize: 15 }}>Start with a 7-day free trial</p>
            </div>

            <div style={{ display: 'flex', flexDirection: 'column', gap: 12, marginBottom: 24 }}>
              <div
                className={`pricing-card ${selectedPlan === 'weekly' ? 'selected' : ''}`}
                onClick={() => setSelectedPlan('weekly')}
              >
                <p className="plan-name">Weekly</p>
                <p className="plan-price">$4.99<span className="plan-period"> / week</span></p>
              </div>

              <div
                className={`pricing-card ${selectedPlan === 'monthly' ? 'selected' : ''}`}
                onClick={() => setSelectedPlan('monthly')}
                style={{ marginTop: 4 }}
              >
                <div className="badge">Most Popular</div>
                <p className="plan-name">Monthly</p>
                <p className="plan-price">$9.99<span className="plan-period"> / month</span></p>
              </div>

              <div
                className={`pricing-card ${selectedPlan === 'yearly' ? 'selected' : ''}`}
                onClick={() => setSelectedPlan('yearly')}
              >
                <div className="badge badge-gold">Best Value</div>
                <p className="plan-name">Yearly</p>
                <p className="plan-price">$29.99<span className="plan-period"> / year</span></p>
              </div>
            </div>

            <button className="btn btn-primary mb-16" onClick={finishOnboarding}>
              Start Free Trial
            </button>

            <div className="text-center mb-12">
              <button className="link-muted" onClick={finishOnboarding} style={{ fontSize: 14 }}>Maybe later</button>
            </div>
            <div className="text-center mb-12">
              <button className="link-muted" style={{ fontSize: 12 }}>Restore Purchases</button>
            </div>
            <div className="text-center">
              <button className="link-muted" onClick={finishOnboarding} style={{ fontSize: 12, color: 'var(--coral)', opacity: 0.7 }}>Skip (Testing)</button>
            </div>
            <div className="spacer" />
          </div>
        );
      }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // SCREEN 24: NOTIFICATION PERMISSION
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

      function NotificationScreen() {
        const handleEnable = () => {
          if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
          }
          next();
        };

        return (
          <div className="screen" key="s24">
            <div className="spacer" style={{ flex: 0.3 }} />
            <div className="text-center mb-32">
              <div style={{
                width: 80, height: 80, borderRadius: '50%',
                background: 'var(--primary-dim)',
                display: 'flex', alignItems: 'center', justifyContent: 'center',
                margin: '0 auto 24px', fontSize: 36
              }}>üîî</div>
              <h2 style={{ fontSize: 24, fontWeight: 700, marginBottom: 8, lineHeight: 1.2 }}>
                Reach your goals with notifications
              </h2>
              <p className="text-muted" style={{ fontSize: 15, lineHeight: 1.4 }}>
                PuffDown uses daily reminders to keep you on track
              </p>
            </div>

            <div className="mock-notif mb-24">
              <div className="mock-notif-icon">ü´Å</div>
              <div>
                <p className="mock-notif-title">PuffDown</p>
                <p className="mock-notif-body">How's your day going? Tap to log and stay on track.</p>
              </div>
              <span className="mock-notif-time">now</span>
            </div>

            <div className="text-center mb-32">
              <p style={{ fontSize: 14, color: 'var(--primary)', fontWeight: 500 }}>
                Users who enable notifications are 80% more likely to succeed
              </p>
            </div>

            <div className="spacer" />
            <button className="btn btn-primary mb-12" onClick={handleEnable}>Enable Notifications</button>
            <div className="text-center">
              <button className="link-muted" onClick={next}>
                Not now
              </button>
            </div>
          </div>
        );
      }

      // ‚îÄ‚îÄ Screen 25: Daily Framework Intro ‚îÄ‚îÄ
      function DailyFrameworkScreen() {
        const goToApp = () => {
          setData(prev => ({
            ...prev,
            onboardingComplete: true,
            startDate: prev.startDate || todayKey(),
            puffLogs: prev.puffLogs || {}
          }));
          setScreen(TOTAL_ONBOARDING_SCREENS);
        };

        const steps = [
          { icon: 'üìä', title: 'Log your puffs', desc: 'Tap once every time you vape. That awareness alone cuts usage by 20-30%.' },
          { icon: 'üìà', title: 'Stay under your target', desc: 'Your daily limit drops gradually. You\'ll barely notice ‚Äî until you look back and see how far you\'ve come.' },
          { icon: 'üìö', title: 'Learn why it matters', desc: 'Quick facts about what vaping does to your body ‚Äî and how fast it heals when you stop.' }
        ];

        return (
          <div className="screen screen-gradient" key="s25">
            <div className="spacer" style={{ flex: 0.2 }} />
            <div className="text-center mb-24">
              <h2 style={{ fontSize: 24, fontWeight: 700, marginBottom: 8, lineHeight: 1.2 }}>
                Your Daily PuffDown Routine
              </h2>
              <p className="text-muted" style={{ fontSize: 15 }}>Simple. Takes 30 seconds a day.</p>
            </div>

            <div className="card mb-16" style={{ padding: 20 }}>
              <div style={{ display: 'flex', flexDirection: 'column', gap: 20 }}>
                {steps.map((s, i) => (
                  <div key={i} className="step-item" style={{ opacity: 1, animation: `fadeInUp 0.4s ease-out ${i * 0.2}s both` }}>
                    <div className="step-circle">{s.icon}</div>
                    <div>
                      <p style={{ fontSize: 16, fontWeight: 600, marginBottom: 2 }}>{s.title}</p>
                      <p className="text-muted" style={{ fontSize: 14, lineHeight: 1.5 }}>{s.desc}</p>
                    </div>
                  </div>
                ))}
              </div>
            </div>

            <div className="card mb-24" style={{ padding: 16, borderColor: 'rgba(45,212,191,0.2)', textAlign: 'center' }}>
              <p style={{ fontSize: 13, color: 'var(--subtext)', lineHeight: 1.5 }}>
                The secret? <span style={{ color: 'var(--primary)', fontWeight: 600 }}>You can't change what you don't measure.</span> Most vapers have no idea how much they actually use. PuffDown makes it impossible to ignore ‚Äî and that's what makes it work.
              </p>
            </div>

            <div className="spacer" />
            <button className="btn btn-primary" onClick={goToApp}>Let's Start</button>
          </div>
        );
      }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // HELPERS
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

      function todayKey() {
        const d = new Date();
        return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
      }

      function daysSince(dateStr) {
        if (!dateStr) return 0;
        const start = new Date(dateStr + 'T00:00:00');
        const now = new Date();
        now.setHours(0, 0, 0, 0);
        return Math.max(0, Math.floor((now - start) / 86400000));
      }

      function calcStreak(puffLogs, dailyPuffs, startDate) {
        if (!startDate) return 0;
        let streak = 0;
        const now = new Date();
        now.setHours(0, 0, 0, 0);
        const check = new Date(now);
        check.setDate(check.getDate() - 1);
        const start = new Date(startDate + 'T00:00:00');
        while (check >= start) {
          const key = check.getFullYear() + '-' + String(check.getMonth() + 1).padStart(2, '0') + '-' + String(check.getDate()).padStart(2, '0');
          const elapsed = Math.floor((check - start) / 86400000);
          const target = Math.max(dailyPuffs - (10 * (elapsed + 1) / 45), 0);
          const logged = (puffLogs && puffLogs[key]) || 0;
          if (logged <= Math.ceil(target)) {
            streak++;
          } else {
            break;
          }
          check.setDate(check.getDate() - 1);
        }
        return streak;
      }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // MAIN APP (Screen 21)
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

      function MainApp() {
        const [activeTab, setActiveTab] = useState('dashboard');
        const startDate = data.startDate || todayKey();
        const puffLogs = data.puffLogs || {};
        const today = todayKey();
        const puffsToday = puffLogs[today] || 0;
        const elapsed = daysSince(startDate);
        const dailyTarget = Math.max(Math.round(data.dailyPuffs - (10 * (elapsed + 1) / 45)), 1);
        const circumference = 2 * Math.PI * 88;
        const progress = Math.min(puffsToday / dailyTarget, 1);
        const offset = circumference * (1 - progress);
        const overLimit = puffsToday > dailyTarget;

        const todayStr = new Date().toLocaleDateString('en-US', {
          weekday: 'long', month: 'long', day: 'numeric'
        });

        useEffect(() => {
          if (!data.startDate) {
            update('startDate', todayKey());
          }
        }, []);

        const streak = calcStreak(puffLogs, data.dailyPuffs, startDate);

        // Savings: puffs avoided * cost per puff (handles both old string and new number format)
        const weeklyMid = getWeeklySpendNum(data.weeklySpend);
        const costPerPuff = weeklyMid / 7 / data.dailyPuffs;
        let totalPuffsAvoided = 0;
        for (let i = 0; i <= elapsed; i++) {
          const d = new Date(startDate + 'T00:00:00');
          d.setDate(d.getDate() + i);
          const key = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
          const logged = puffLogs[key] || 0;
          const avoided = Math.max(data.dailyPuffs - logged, 0);
          totalPuffsAvoided += avoided;
        }
        const saved = Math.round(totalPuffsAvoided * costPerPuff * 100) / 100;

        const [fabToast, setFabToast] = useState(false);
        const fabToastTimer = React.useRef(null);

        const logPuff = useCallback(() => {
          setData(prev => {
            const logs = { ...prev.puffLogs } || {};
            logs[today] = (logs[today] || 0) + 1;
            return { ...prev, puffLogs: logs, startDate: prev.startDate || today };
          });
        }, [today]);

        const logPuffWithFeedback = useCallback(() => {
          logPuff();
          // Haptic
          if (navigator.vibrate) navigator.vibrate(25);
          // FAB bump animation
          const fab = document.querySelector('.puff-fab');
          if (fab) {
            fab.classList.remove('bumped');
            void fab.offsetWidth;
            fab.classList.add('bumped');
          }
          // Toast
          setFabToast(true);
          clearTimeout(fabToastTimer.current);
          fabToastTimer.current = setTimeout(() => setFabToast(false), 1200);
        }, [logPuff]);

        // URL shortcuts: ?action=log or ?reset=true
        useEffect(() => {
          const params = new URLSearchParams(window.location.search);
          if (params.get('action') === 'log') {
            logPuff();
            window.history.replaceState({}, '', window.location.pathname);
          }
          if (params.get('reset') === 'true') {
            window.devReset();
            window.history.replaceState({}, '', window.location.pathname);
          }
        }, [logPuff]);

        // Listen for LOG_PUFF postMessage from service worker
        useEffect(() => {
          const handler = (event) => {
            if (event.data && event.data.type === 'LOG_PUFF') {
              logPuff();
            }
          };
          navigator.serviceWorker && navigator.serviceWorker.addEventListener('message', handler);
          return () => {
            navigator.serviceWorker && navigator.serviceWorker.removeEventListener('message', handler);
          };
        }, [logPuff]);

        // Request notification permission for existing users (3s delay)
        useEffect(() => {
          if ('Notification' in window && Notification.permission === 'default') {
            const t = setTimeout(() => Notification.requestPermission(), 3000);
            return () => clearTimeout(t);
          }
        }, []);

        // Schedule reminder notifications every 2 hours
        useEffect(() => {
          if (!('Notification' in window) || Notification.permission !== 'granted') return;
          if (!navigator.serviceWorker || !navigator.serviceWorker.controller) return;

          const NOTIF_INTERVAL = 2 * 60 * 60 * 1000;
          const LAST_NOTIF_KEY = 'puffdown_last_notif';

          function scheduleNext() {
            const lastNotif = parseInt(localStorage.getItem(LAST_NOTIF_KEY) || '0', 10);
            const now = Date.now();
            const timeSinceLast = now - lastNotif;
            const delay = timeSinceLast >= NOTIF_INTERVAL ? 0 : NOTIF_INTERVAL - timeSinceLast;

            return setTimeout(async () => {
              try {
                const reg = await navigator.serviceWorker.ready;
                const msgIndex = Math.floor(Math.random() * NOTIF_MESSAGES.length);
                const msg = NOTIF_MESSAGES[msgIndex];
                await reg.showNotification(msg.title, {
                  body: msg.body,
                  icon: './icon-192.png',
                  badge: './icon-192.png',
                  tag: 'puffdown-reminder',
                  renotify: true
                });
                localStorage.setItem(LAST_NOTIF_KEY, String(Date.now()));
              } catch (e) {}
              timerId = scheduleNext();
            }, Math.max(delay, 60000));
          }

          let timerId = scheduleNext();
          return () => clearTimeout(timerId);
        }, []);

        const resetOnboarding = () => {
          const fresh = {
            userName: '', goals: [], longTermGoal: null,
            vapeType: null, dailyPuffs: 150, vapingDuration: null,
            weeklySpend: 30, lifeImpact: 3, triggers: [],
            biggestStruggle: null, quitAttempts: null,
            onboardingComplete: false
          };
          saveData(fresh);
          setData(fresh);
          setScreen(0);
        };

        const dayOfYear = Math.floor((Date.now() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
        const dailyFact = DAILY_FACTS[dayOfYear % DAILY_FACTS.length];

        const minutesSinceStart = startDate
          ? (Date.now() - new Date(startDate + 'T00:00:00').getTime()) / 60000
          : 0;

        const nextMilestoneIdx = HEALTH_TIMELINE.findIndex(m => m.minutes > minutesSinceStart);

        // ‚îÄ‚îÄ Dashboard Tab ‚îÄ‚îÄ
        function DashboardTab() {
          return (
            <div className="tab-content">
              <div className="text-center mb-8">
                <p className="text-muted" style={{ fontSize: 13 }}>{todayStr}</p>
                <h2 style={{ fontSize: 28, fontWeight: 700, marginTop: 4, lineHeight: 1.1 }}>
                  {displayName ? `${displayName}'s Day ${elapsed + 1}` : `Day ${elapsed + 1}`}
                </h2>
              </div>

              <div style={{ height: 16 }} />

              <div className="progress-ring-container mb-24">
                <svg viewBox="0 0 200 200">
                  <circle className="progress-ring-bg" cx="100" cy="100" r="88" />
                  <circle
                    className="progress-ring-fill"
                    cx="100" cy="100" r="88"
                    strokeDasharray={circumference}
                    strokeDashoffset={offset}
                    style={overLimit ? { stroke: 'var(--coral)' } : {}}
                  />
                </svg>
                <div className="progress-ring-text">
                  <span style={{ fontSize: 48, fontWeight: 700, color: overLimit ? 'var(--coral)' : 'var(--text)' }}>{puffsToday}</span>
                  <span className="text-muted" style={{ fontSize: 15 }}>/ {dailyTarget} puffs</span>
                </div>
              </div>

              <div className="stat-row mb-24">
                <div className="stat-box">
                  <div className="stat-value" style={{ color: 'var(--primary)' }}>{streak}</div>
                  <div className="stat-label">Day Streak</div>
                </div>
                <div className="stat-box">
                  <div className="stat-value" style={{ color: 'var(--gold)' }}>${saved.toFixed(0)}</div>
                  <div className="stat-label">Saved</div>
                </div>
                <div className="stat-box">
                  <div className="stat-value" style={{ color: 'var(--mint)' }}>Day {elapsed + 1}</div>
                  <div className="stat-label">Journey</div>
                </div>
              </div>

              <button className="btn btn-primary mb-16" onClick={logPuffWithFeedback}>
                + Log a Puff
              </button>

              <div className="daily-fact mb-16">
                <p style={{ fontSize: 11, fontWeight: 600, color: 'var(--primary)', textTransform: 'uppercase', letterSpacing: 0.5, marginBottom: 6 }}>
                  Daily Fact
                </p>
                <p style={{ fontSize: 14, color: 'var(--subtext)', lineHeight: 1.5 }}>{dailyFact}</p>
              </div>

              <div className="text-center">
                <button className="link-muted" onClick={resetOnboarding} style={{ fontSize: 12 }}>
                  Reset Onboarding (dev)
                </button>
              </div>
              <div style={{ height: 16 }} />
            </div>
          );
        }

        // ‚îÄ‚îÄ Timeline Tab ‚îÄ‚îÄ
        function TimelineTab() {
          return (
            <div className="tab-content">
              <div className="text-center mb-24">
                <h2 style={{ fontSize: 24, fontWeight: 700, lineHeight: 1.1 }}>Health Timeline</h2>
                <p className="text-muted" style={{ fontSize: 13, marginTop: 6 }}>
                  Your body is healing. Here's what's happening.
                </p>
              </div>
              {HEALTH_TIMELINE.map((milestone, i) => {
                const achieved = minutesSinceStart >= milestone.minutes;
                const isNext = i === nextMilestoneIdx;
                const status = achieved ? 'achieved' : isNext ? 'next' : 'future';
                return (
                  <div className={`milestone-card ${status}`} key={i}>
                    <div className="milestone-icon">{milestone.emoji}</div>
                    <div style={{ flex: 1 }}>
                      <p style={{ fontSize: 12, color: 'var(--subtext)', marginBottom: 2 }}>{milestone.time}</p>
                      <p style={{ fontSize: 15, fontWeight: 600, marginBottom: 4 }}>{milestone.title}</p>
                      <p style={{ fontSize: 13, color: 'var(--subtext)', lineHeight: 1.4 }}>{milestone.desc}</p>
                      {achieved && <span className="milestone-badge">Achieved</span>}
                      {isNext && <span className="milestone-badge">Next</span>}
                    </div>
                  </div>
                );
              })}
              <div style={{ height: 16 }} />
            </div>
          );
        }

        // ‚îÄ‚îÄ Learn Tab ‚îÄ‚îÄ
        function LearnTab() {
          return (
            <div className="tab-content">
              <div className="text-center mb-24">
                <h2 style={{ fontSize: 24, fontWeight: 700, lineHeight: 1.1 }}>Learn</h2>
                <p className="text-muted" style={{ fontSize: 13, marginTop: 6 }}>
                  Knowledge is power. Understand what vaping does.
                </p>
              </div>
              {VAPE_FACTS.map((fact, i) => (
                <div className="fact-card" key={i}>
                  <span className="fact-emoji">{fact.emoji}</span>
                  <p className="fact-title">{fact.title}</p>
                  <p className="fact-body">{fact.body}</p>
                </div>
              ))}
              <div style={{ height: 16 }} />
            </div>
          );
        }

        return (
          <React.Fragment>
            <div className="screen-with-tabs" key="main">
              {activeTab === 'dashboard' && <DashboardTab />}
              {activeTab === 'timeline' && <TimelineTab />}
              {activeTab === 'learn' && <LearnTab />}
            </div>

            {/* Floating puff button */}
            <div className={`puff-fab-toast ${fabToast ? 'show' : ''}`}>
              Puff logged
            </div>
            <button className={`puff-fab ${overLimit ? 'over-target' : ''}`} onClick={logPuffWithFeedback} aria-label="Log a puff">
              <svg viewBox="0 0 28 80" fill="none">
                <rect x="6" y="12" width="16" height="52" rx="4" fill="#0D1117"/>
                <rect x="6" y="32" width="16" height="2" rx="1" fill="#0D1117" opacity="0.5"/>
                <rect x="9" y="0" width="10" height="12" rx="3" fill="#0D1117" opacity="0.7"/>
                <rect x="8" y="62" width="12" height="10" rx="3" fill="#0D1117" opacity="0.7"/>
                <circle cx="14" cy="67" r="2" fill="#0D1117" opacity="0.5"/>
              </svg>
            </button>

            <div className="tab-bar">
              <button className={`tab-item ${activeTab === 'dashboard' ? 'active' : ''}`} onClick={() => setActiveTab('dashboard')}>
                <span className="tab-icon">üìä</span>
                <span className="tab-label">Dashboard</span>
              </button>
              <button className={`tab-item ${activeTab === 'timeline' ? 'active' : ''}`} onClick={() => setActiveTab('timeline')}>
                <span className="tab-icon">‚è±Ô∏è</span>
                <span className="tab-label">Timeline</span>
              </button>
              <button className={`tab-item ${activeTab === 'learn' ? 'active' : ''}`} onClick={() => setActiveTab('learn')}>
                <span className="tab-icon">üìö</span>
                <span className="tab-label">Learn</span>
              </button>
            </div>
          </React.Fragment>
        );
      }

      // ‚îÄ‚îÄ Screen router ‚îÄ‚îÄ
      const screens = [
        WelcomeScreen,           // 0  - Welcome + name
        GoalsScreen,             // 1  - Goals multi-select
        GoalsReflectionScreen,   // 2  - Goals reflection (NEW)
        LongTermGoalScreen,      // 3  - Long-term goal
        VapeTypeScreen,          // 4  - Vape type
        DailyPuffsScreen,        // 5  - Daily puffs slider
        VapingDurationScreen,    // 6  - How long vaping
        WeeklySpendScreen,       // 7  - Weekly spend slider
        LifeImpactScreen,        // 8  - Emoji life impact slider
        TriggersScreen,          // 9  - Triggers multi-select
        BiggestStruggleScreen,   // 10 - Biggest struggle
        QuitAttemptsScreen,      // 11 - Quit attempts
        MotivationalScreen,      // 12 - Motivational interstitial (NEW)
        TransitionScreen,        // 13 - Transition / analyzing
        SnapshotScreen,          // 14 - Personalized snapshot
        SocialProofScreen,       // 15 - Social proof (NEW)
        ComparisonScreen,        // 16 - Usage comparison
        GoalsSolutionScreen,     // 17 - Goals + solution
        PersonalPlanScreen,      // 18 - Your plan
        WowMomentScreen,         // 19 - Interactive demo
        FairTrialScreen,         // 20 - Fair trial reframe (NEW)
        PaywallStep1Screen,      // 21 - Paywall features
        PaywallStep2Screen,      // 22 - Paywall trust
        PaywallStep3Screen,      // 23 - Paywall pricing
        NotificationScreen,      // 24 - Notification permission
        DailyFrameworkScreen,    // 25 - Daily framework (NEW)
        MainApp                  // 26 - Main app
      ];

      // ‚îÄ‚îÄ Dev helpers (call from browser console) ‚îÄ‚îÄ
      window.devUnlock = () => {
        setData(prev => ({
          ...prev,
          isPremium: true,
          onboardingComplete: true,
          startDate: prev.startDate || todayKey(),
          puffLogs: prev.puffLogs || {}
        }));
        setScreen(TOTAL_ONBOARDING_SCREENS);
        console.log('Premium unlocked ‚Äî skipped to main app');
      };
      window.devSkipTo = (n) => {
        setScreen(n);
        console.log('Jumped to screen ' + n);
      };
      window.devReset = () => {
        const fresh = {
          userName: '', goals: [], longTermGoal: null,
          vapeType: null, dailyPuffs: 150, vapingDuration: null,
          weeklySpend: 30, spendPeriod: 'every2weeks', spendRaw: 40,
          lifeImpact: 3, triggers: [], biggestStruggle: null,
          quitAttempts: null, onboardingComplete: false, isPremium: false
        };
        saveData(fresh);
        setData(fresh);
        setScreen(0);
        console.log('Reset to fresh state');
      };

      const CurrentScreen = screens[screen] || MainApp;
      return <CurrentScreen />;
    }

    // ‚îÄ‚îÄ Mount ‚îÄ‚îÄ
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);

    // ‚îÄ‚îÄ Register service worker ‚îÄ‚îÄ
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js').catch(() => {});
    }
  </script>
</body>
</html>
