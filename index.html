<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0D1117">
  <title>PuffDown</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <style>
    :root {
      --bg: #0D1117;
      --card: #161B22;
      --card-border: #21262D;
      --primary: #2DD4BF;
      --primary-dim: rgba(45,212,191,0.12);
      --mint: #86EFAC;
      --mint-dim: rgba(134,239,172,0.12);
      --gold: #FBBF24;
      --gold-dim: rgba(251,191,36,0.12);
      --coral: #F87171;
      --coral-dim: rgba(248,113,113,0.12);
      --text: #FFFFFF;
      --subtext: #9CA3AF;
      --dark-grey: #6B7280;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'SF Pro Rounded', 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      overscroll-behavior: none;
      user-select: none;
      -webkit-user-select: none;
      line-height: 1.3;
    }
    .screen {
      position: fixed; inset: 0;
      display: flex; flex-direction: column;
      padding: calc(var(--safe-top) + 16px) 20px calc(var(--safe-bottom) + 24px);
      animation: slideInRight 0.3s ease-out;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(40px); }
      to { opacity: 1; transform: translateX(0); }
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes countPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    @keyframes popIn {
      0% { transform: scale(0.8); opacity: 0; }
      60% { transform: scale(1.05); }
      100% { transform: scale(1); opacity: 1; }
    }

    /* Progress bar (green gradient, Clear30-inspired) */
    .progress-bar-container {
      width: 100%; height: 6px;
      background: var(--card-border); border-radius: 3px;
      margin-bottom: 32px;
    }
    .progress-bar-fill {
      height: 100%; border-radius: 3px;
      background: linear-gradient(90deg, #2DD4BF, #86EFAC);
      transition: width 0.4s ease;
    }

    /* Buttons */
    .btn {
      width: 100%; height: 56px;
      border: none; border-radius: 16px;
      font-family: inherit;
      font-size: 17px; font-weight: 600;
      cursor: pointer; transition: all 0.2s;
      display: flex; align-items: center; justify-content: center;
      -webkit-tap-highlight-color: transparent;
    }
    .btn-primary {
      background: var(--primary); color: #FFFFFF;
    }
    .btn-primary:active { transform: scale(0.97); opacity: 0.9; }
    .btn-primary:disabled {
      background: var(--card-border); color: var(--dark-grey);
      cursor: default; transform: none;
    }
    .btn-outline {
      background: transparent; color: var(--primary);
      border: 1.5px solid var(--primary);
    }
    .btn-outline:active { background: var(--primary-dim); }

    /* Cards */
    .card {
      background: var(--card); border: 1px solid var(--card-border);
      border-radius: 16px; padding: 16px;
    }
    .option-card {
      background: var(--card); border: 1.5px solid var(--card-border);
      border-radius: 14px; padding: 16px 18px;
      cursor: pointer; transition: all 0.15s;
      -webkit-tap-highlight-color: transparent;
      display: flex; align-items: center; gap: 14px;
    }
    .option-card:active { transform: scale(0.98); }
    .option-card.selected {
      border-color: var(--primary);
      border-width: 2px;
      background: var(--primary-dim);
    }
    .option-card.selected .label { color: var(--primary); }
    .option-card .emoji { font-size: 28px; flex-shrink: 0; }
    .option-card .label {
      font-size: 15px; font-weight: 500;
      transition: color 0.15s;
    }

    /* Multi-select card (allows up to 3) */
    .multi-select-card {
      background: var(--card); border: 1.5px solid var(--card-border);
      border-radius: 14px; padding: 14px 16px;
      cursor: pointer; transition: all 0.15s;
      -webkit-tap-highlight-color: transparent;
      display: flex; align-items: center; gap: 12px;
    }
    .multi-select-card:active { transform: scale(0.98); }
    .multi-select-card.selected {
      border-color: var(--primary);
      border-width: 2px;
      background: var(--primary-dim);
    }
    .multi-select-card .ms-check {
      width: 24px; height: 24px; border-radius: 8px;
      border: 2px solid var(--card-border);
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0; transition: all 0.15s;
      font-size: 13px; color: transparent;
    }
    .multi-select-card.selected .ms-check {
      background: var(--primary); border-color: var(--primary);
      color: #fff;
    }
    .multi-select-card .emoji { font-size: 24px; flex-shrink: 0; }
    .multi-select-card .label { font-size: 15px; font-weight: 500; }
    .multi-select-card.selected .label { color: var(--primary); }

    /* Option grid (2x2) */
    .option-grid {
      display: grid; grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .option-grid .option-card {
      flex-direction: column; text-align: center;
      padding: 20px 12px; gap: 10px;
      min-height: 52px;
    }
    .option-grid .option-card .emoji { font-size: 36px; }

    /* Option stack */
    .option-stack { display: flex; flex-direction: column; gap: 12px; }

    /* Multi-select grid */
    .multi-select-grid {
      display: grid; grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .multi-select-grid .multi-select-card {
      flex-direction: column; text-align: center;
      padding: 16px 10px; gap: 8px;
    }
    .multi-select-grid .multi-select-card .ms-check {
      position: absolute; top: 8px; right: 8px;
      width: 20px; height: 20px; border-radius: 6px;
    }
    .multi-select-grid .multi-select-card {
      position: relative;
    }
    .multi-select-grid .multi-select-card .emoji { font-size: 28px; }
    .multi-select-grid .multi-select-card .label { font-size: 13px; }

    /* Name input */
    .name-input {
      width: 100%; height: 56px;
      background: var(--card); border: 1.5px solid var(--card-border);
      border-radius: 16px; padding: 0 20px;
      font-family: inherit; font-size: 17px; font-weight: 500;
      color: var(--text); outline: none;
      transition: border-color 0.2s;
    }
    .name-input::placeholder { color: var(--dark-grey); }
    .name-input:focus { border-color: var(--primary); }

    /* Range slider */
    input[type="range"] {
      -webkit-appearance: none; width: 100%; height: 6px;
      background: var(--card-border); border-radius: 3px; outline: none;
      margin: 20px 0;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none; width: 28px; height: 28px;
      background: var(--primary); border-radius: 50%;
      cursor: pointer; border: 3px solid var(--bg);
      box-shadow: 0 0 12px rgba(45,212,191,0.35);
    }
    input[type="range"]::-moz-range-thumb {
      width: 28px; height: 28px;
      background: var(--primary); border-radius: 50%;
      cursor: pointer; border: 3px solid var(--bg);
    }

    /* Emoji slider (life impact) */
    .emoji-slider-face {
      font-size: 64px; text-align: center;
      transition: all 0.2s;
    }
    .emoji-slider-labels {
      display: flex; justify-content: space-between;
      font-size: 13px; color: var(--subtext);
    }

    /* Snapshot visualization bars */
    .snapshot-bar-container {
      margin-bottom: 20px;
    }
    .snapshot-bar-label {
      display: flex; justify-content: space-between;
      align-items: center; margin-bottom: 8px;
    }
    .snapshot-bar-label .bar-title {
      font-size: 14px; font-weight: 600;
    }
    .snapshot-bar-label .bar-value {
      font-size: 14px; font-weight: 700;
    }
    .snapshot-bar {
      width: 100%; height: 12px;
      background: var(--card-border); border-radius: 6px;
      overflow: hidden;
    }
    .snapshot-bar-fill {
      height: 100%; border-radius: 6px;
      transition: width 1.2s ease-out;
    }
    .snapshot-bar-fill.red { background: linear-gradient(90deg, #F87171, #EF4444); }
    .snapshot-bar-fill.orange { background: linear-gradient(90deg, #FBBF24, #F59E0B); }
    .snapshot-bar-fill.green { background: linear-gradient(90deg, #2DD4BF, #86EFAC); }

    /* Comparison bars */
    .comparison-bar-wrapper {
      margin-bottom: 16px;
    }
    .comparison-bar-label {
      font-size: 14px; font-weight: 500; margin-bottom: 6px;
      display: flex; align-items: center; gap: 8px;
    }
    .comparison-bar-track {
      width: 100%; height: 28px;
      background: var(--card-border); border-radius: 14px;
      overflow: hidden; position: relative;
    }
    .comparison-bar-value {
      height: 100%; border-radius: 14px;
      display: flex; align-items: center;
      padding: 0 12px; font-size: 12px; font-weight: 700;
      transition: width 1.2s ease-out;
      min-width: 40px;
    }
    .comparison-bar-value.green { background: linear-gradient(90deg, #2DD4BF, #86EFAC); color: #0D1117; }
    .comparison-bar-value.red { background: linear-gradient(90deg, #F87171, #EF4444); color: #fff; }

    /* Green gradient background for transition screens */
    .screen-gradient {
      background: linear-gradient(180deg, rgba(45,212,191,0.08) 0%, var(--bg) 60%);
    }

    /* Progress ring (SVG) */
    .progress-ring-container {
      position: relative; width: 200px; height: 200px;
      margin: 0 auto;
    }
    .progress-ring-container svg { width: 100%; height: 100%; transform: rotate(-90deg); }
    .progress-ring-bg { fill: none; stroke: var(--card-border); stroke-width: 8; }
    .progress-ring-fill {
      fill: none; stroke: var(--primary); stroke-width: 8;
      stroke-linecap: round;
      transition: stroke-dashoffset 0.8s ease-in-out;
    }
    .progress-ring-text {
      position: absolute; inset: 0;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
    }

    /* Stat boxes */
    .stat-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    .stat-box {
      background: var(--card); border: 1px solid var(--card-border);
      border-radius: 16px; padding: 14px 10px; text-align: center;
    }
    .stat-box .stat-value {
      font-size: 22px; font-weight: 700; color: var(--primary);
    }
    .stat-box .stat-label {
      font-size: 11px; color: var(--subtext); margin-top: 4px;
      text-transform: uppercase; letter-spacing: 0.5px;
      font-weight: 500;
    }

    /* Paywall pricing cards */
    .pricing-card {
      background: var(--card); border: 1.5px solid var(--card-border);
      border-radius: 16px; padding: 20px;
      cursor: pointer; transition: all 0.15s;
      position: relative; text-align: center;
    }
    .pricing-card:active { transform: scale(0.98); }
    .pricing-card.selected {
      border-color: var(--primary);
      border-width: 2px;
    }
    .pricing-card .badge {
      position: absolute; top: -11px; left: 50%; transform: translateX(-50%);
      background: var(--primary); color: var(--bg);
      font-size: 11px; font-weight: 700; padding: 3px 12px;
      border-radius: 8px; text-transform: uppercase;
      white-space: nowrap;
    }
    .pricing-card .badge-gold {
      background: var(--gold); color: var(--bg);
    }
    .pricing-card .plan-name {
      font-size: 14px; color: var(--subtext); margin-bottom: 6px;
    }
    .pricing-card .plan-price {
      font-size: 28px; font-weight: 700;
    }
    .pricing-card .plan-period {
      font-size: 13px; color: var(--subtext);
    }

    /* Feature row */
    .feature-row {
      display: flex; align-items: center; gap: 14px;
      padding: 14px 0;
    }
    .feature-row + .feature-row { border-top: 1px solid var(--card-border); }
    .feature-check {
      width: 28px; height: 28px; border-radius: 50%;
      background: var(--mint-dim);
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0; color: var(--mint); font-size: 14px; font-weight: 700;
    }

    /* Step circles (how it works) */
    .step-item {
      display: flex; gap: 16px; align-items: flex-start;
      opacity: 0; animation: fadeInUp 0.4s ease-out forwards;
    }
    .step-item:nth-child(1) { animation-delay: 0.1s; }
    .step-item:nth-child(2) { animation-delay: 0.3s; }
    .step-item:nth-child(3) { animation-delay: 0.5s; }
    .step-circle {
      width: 40px; height: 40px; border-radius: 50%;
      background: var(--primary-dim); border: 1.5px solid var(--primary);
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; color: var(--primary); flex-shrink: 0;
      font-size: 16px;
    }

    /* Goal chip (for personalized screens) */
    .goal-chip {
      display: inline-flex; align-items: center; gap: 8px;
      background: var(--primary-dim); border: 1px solid rgba(45,212,191,0.2);
      border-radius: 12px; padding: 10px 16px;
      font-size: 14px; font-weight: 500; color: var(--primary);
    }

    /* Links */
    .link-muted {
      color: var(--dark-grey); font-size: 13px;
      font-family: inherit;
      text-decoration: none; cursor: pointer;
      background: none; border: none;
      -webkit-tap-highlight-color: transparent;
    }
    .link-muted:active { opacity: 0.6; }

    /* Spacer helpers */
    .spacer { flex: 1; }
    .mb-8 { margin-bottom: 8px; }
    .mb-12 { margin-bottom: 12px; }
    .mb-16 { margin-bottom: 16px; }
    .mb-20 { margin-bottom: 20px; }
    .mb-24 { margin-bottom: 24px; }
    .mb-32 { margin-bottom: 32px; }
    .mt-auto { margin-top: auto; }
    .text-center { text-align: center; }
    .text-muted { color: var(--subtext); }
    .text-primary { color: var(--primary); }

    /* Tab bar */
    .tab-bar {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: var(--card);
      border-top: 1px solid var(--card-border);
      display: flex; justify-content: space-around;
      padding: 8px 0 calc(var(--safe-bottom) + 8px);
      z-index: 100;
    }
    .tab-item {
      display: flex; flex-direction: column; align-items: center;
      gap: 4px; padding: 4px 16px;
      background: none; border: none; cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      font-family: inherit;
    }
    .tab-item .tab-icon { font-size: 22px; line-height: 1; }
    .tab-item .tab-label {
      font-size: 10px; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.5px;
      color: var(--dark-grey); transition: color 0.15s;
    }
    .tab-item.active .tab-label { color: var(--primary); }

    /* Main app screen with tab bar */
    .screen-with-tabs {
      position: fixed; inset: 0;
      display: flex; flex-direction: column;
      padding: calc(var(--safe-top) + 24px) 20px 0;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    .tab-content {
      flex: 1; padding-bottom: calc(70px + var(--safe-bottom));
    }

    /* Timeline milestone cards */
    .milestone-card {
      background: var(--card); border: 1px solid var(--card-border);
      border-radius: 16px; padding: 16px;
      display: flex; align-items: center; gap: 14px;
      margin-bottom: 12px; transition: opacity 0.2s;
    }
    .milestone-card.achieved { border-color: rgba(134,239,172,0.3); }
    .milestone-card.next { border-color: var(--gold); }
    .milestone-card.future { opacity: 0.5; }
    .milestone-icon {
      width: 44px; height: 44px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 20px; flex-shrink: 0;
    }
    .milestone-card.achieved .milestone-icon { background: var(--mint-dim); }
    .milestone-card.next .milestone-icon { background: var(--gold-dim); }
    .milestone-card.future .milestone-icon { background: var(--card-border); }
    .milestone-badge {
      font-size: 10px; font-weight: 700; text-transform: uppercase;
      letter-spacing: 0.5px; padding: 2px 8px; border-radius: 6px;
      display: inline-block; margin-top: 4px;
    }
    .milestone-card.achieved .milestone-badge { background: var(--mint-dim); color: var(--mint); }
    .milestone-card.next .milestone-badge { background: var(--gold-dim); color: var(--gold); }

    /* Learn fact cards */
    .fact-card {
      background: var(--card); border: 1px solid var(--card-border);
      border-radius: 16px; padding: 20px;
      margin-bottom: 12px;
    }
    .fact-card .fact-emoji {
      font-size: 32px; margin-bottom: 10px; display: block;
    }
    .fact-card .fact-title {
      font-size: 16px; font-weight: 600; margin-bottom: 6px;
    }
    .fact-card .fact-body {
      font-size: 14px; color: var(--subtext); line-height: 1.5;
    }

    /* Daily fact card */
    .daily-fact {
      background: linear-gradient(135deg, rgba(45,212,191,0.08), rgba(134,239,172,0.08));
      border: 1px solid rgba(45,212,191,0.2);
      border-radius: 16px; padding: 16px;
    }

    /* Mock notification */
    .mock-notif {
      background: #1C1C1E; border-radius: 16px; padding: 14px 16px;
      display: flex; align-items: flex-start; gap: 12px;
      border: 1px solid rgba(255,255,255,0.08);
    }
    .mock-notif-icon {
      width: 36px; height: 36px; border-radius: 10px;
      background: var(--primary-dim);
      display: flex; align-items: center; justify-content: center;
      font-size: 18px; flex-shrink: 0;
    }
    .mock-notif-title { font-size: 14px; font-weight: 600; margin-bottom: 2px; }
    .mock-notif-body { font-size: 13px; color: var(--subtext); }
    .mock-notif-time { font-size: 11px; color: var(--dark-grey); margin-left: auto; flex-shrink: 0; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    // â”€â”€ Storage helpers â”€â”€
    const STORAGE_KEY = 'puffdown_data';
    function loadData() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : null;
      } catch { return null; }
    }
    function saveData(d) {
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); } catch {}
    }

    // â”€â”€ Count-up animation hook â”€â”€
    function useCountUp(target, duration = 1500, delay = 0) {
      const [value, setValue] = useState(0);

      useEffect(() => {
        let start = null;
        let animId;
        const timeout = setTimeout(() => {
          const step = (ts) => {
            if (!start) start = ts;
            const elapsed = ts - start;
            const progress = Math.min(elapsed / duration, 1);
            const eased = 1 - Math.pow(1 - progress, 3);
            setValue(Math.round(target * eased));
            if (progress < 1) {
              animId = requestAnimationFrame(step);
            }
          };
          animId = requestAnimationFrame(step);
        }, delay);

        return () => {
          clearTimeout(timeout);
          if (animId) cancelAnimationFrame(animId);
        };
      }, [target, duration, delay]);

      return value;
    }

    // â”€â”€ Spend ranges â†’ midpoint weekly $ (legacy migration) â”€â”€
    const SPEND_MAP = {
      under_15: 10,
      '15_30': 22.5,
      '30_50': 40,
      '50_plus': 65
    };

    // â”€â”€ Get weekly spend as a number (handles old string format + new number format) â”€â”€
    function getWeeklySpendNum(weeklySpend) {
      if (typeof weeklySpend === 'number') return weeklySpend;
      if (typeof weeklySpend === 'string') return SPEND_MAP[weeklySpend] || 22.5;
      return 22.5;
    }

    // â”€â”€ Goal emoji map â”€â”€
    const GOAL_EMOJIS = {
      'Breathe easier': 'ğŸ«',
      'Save money': 'ğŸ’°',
      'Break the addiction': 'ğŸ’ª',
      'Mental clarity': 'ğŸ§ ',
      'Better fitness': 'ğŸƒ',
      'Improve relationships': 'â¤ï¸',
      'Feel in control': 'ğŸ¯',
      'Better sleep': 'ğŸ˜´'
    };

    // â”€â”€ Health recovery timeline â”€â”€
    const HEALTH_TIMELINE = [
      { time: '20 min', minutes: 20, title: 'Heart rate normalizes', desc: 'Your heart rate and blood pressure begin to drop back to normal levels.', emoji: 'â¤ï¸' },
      { time: '8 hours', minutes: 480, title: 'Oxygen levels recover', desc: 'Carbon monoxide levels in your blood drop. Oxygen levels return to normal.', emoji: 'ğŸ«' },
      { time: '24 hours', minutes: 1440, title: 'Heart attack risk drops', desc: 'Your risk of a heart attack begins to decrease as your cardiovascular system starts healing.', emoji: 'ğŸ’ª' },
      { time: '48 hours', minutes: 2880, title: 'Taste & smell return', desc: 'Nerve endings start regrowing. Your sense of taste and smell begin to sharpen.', emoji: 'ğŸ‘ƒ' },
      { time: '72 hours', minutes: 4320, title: 'Breathing gets easier', desc: 'Bronchial tubes relax and lung capacity starts to increase. Breathing feels easier.', emoji: 'ğŸŒ¬ï¸' },
      { time: '2 weeks', minutes: 20160, title: 'Circulation improves', desc: 'Blood flow improves throughout your body. Walking and exercise become easier.', emoji: 'ğŸƒ' },
      { time: '1 month', minutes: 43200, title: 'Immune system strengthens', desc: 'Your immune system begins to recover. You get sick less often.', emoji: 'ğŸ›¡ï¸' },
      { time: '3 months', minutes: 129600, title: 'Lung function up 30%', desc: 'Your lung function has significantly improved. Coughing and shortness of breath decrease.', emoji: 'ğŸ“ˆ' },
      { time: '1 year', minutes: 525600, title: 'Heart disease risk halved', desc: 'Your risk of coronary heart disease is now half that of a vaper. A massive milestone.', emoji: 'ğŸ†' }
    ];

    // â”€â”€ Vape education facts â”€â”€
    const VAPE_FACTS = [
      { emoji: 'ğŸ§ª', title: 'What\'s in vape juice?', body: 'Vape liquid contains propylene glycol, vegetable glycerin, nicotine, and flavoring chemicals. When heated, these produce formaldehyde, acrolein, and heavy metals like lead and nickel â€” none of which belong in your lungs.' },
      { emoji: 'ğŸ§ ', title: 'Nicotine & your brain', body: 'A single JUUL pod contains as much nicotine as 20 cigarettes. Nicotine rewires your brain\'s reward system, making it harder to feel pleasure from everyday activities. Young brains are especially vulnerable.' },
      { emoji: 'ğŸ«', title: 'Popcorn lung risk', body: 'Diacetyl, a flavoring chemical found in many vape juices, is linked to bronchiolitis obliterans ("popcorn lung") â€” a serious, irreversible condition that scars the tiny air sacs in your lungs.' },
      { emoji: 'â¤ï¸', title: 'Heart damage', body: 'Nicotine raises blood pressure, spikes adrenaline, and increases heart rate. Studies show vaping just once can stiffen arteries. Long-term use significantly raises the risk of heart attack and stroke.' },
      { emoji: 'ğŸ›¡ï¸', title: 'Weakened immunity', body: 'Vaping suppresses the immune response in your nasal passages and lungs. Regular vapers are more susceptible to respiratory infections, including flu and pneumonia.' },
      { emoji: 'ğŸ§¬', title: 'DNA damage', body: 'Research has found that e-cigarette vapor damages DNA in the mouth, lungs, and bladder. DNA damage is the first step toward cancer. The longer you vape, the more damage accumulates.' },
      { emoji: 'ğŸ’¨', title: 'Secondhand vapor', body: 'Exhaled vapor contains ultrafine particles, nicotine, heavy metals, and volatile organic compounds. People around you â€” especially children â€” breathe these in. "It\'s just water vapor" is a myth.' },
      { emoji: 'ğŸ’°', title: 'The cost adds up', body: 'The average vaper spends $1,000â€“$2,500 per year. That\'s a vacation, a new phone, or months of groceries. Quitting puts real money back in your pocket â€” starting on day one.' },
      { emoji: 'ğŸ˜°', title: 'Anxiety & depression link', body: 'While many vape to "relieve stress," nicotine actually increases anxiety and depression over time. The relief you feel is just the withdrawal easing temporarily â€” a cycle that gets worse.' },
      { emoji: 'ğŸ˜¬', title: 'Oral health damage', body: 'Vaping dries out your mouth, kills healthy bacteria, and inflames gums. This leads to cavities, gum disease, and bad breath. Some users develop painful mouth sores and cracked lips.' },
      { emoji: 'ğŸ‹ï¸', title: 'Fitness impact', body: 'Vaping reduces lung capacity, restricts blood flow, and increases resting heart rate. Athletes who vape notice decreased endurance, slower recovery, and increased breathlessness during exercise.' },
      { emoji: 'ğŸ˜´', title: 'Sleep disruption', body: 'Nicotine is a stimulant that disrupts your sleep cycle. Vapers take longer to fall asleep, sleep less deeply, and wake up more tired. Poor sleep worsens mood, focus, and cravings.' }
    ];

    // â”€â”€ Daily tips / facts (rotates by day of year) â”€â”€
    const DAILY_FACTS = [
      'Every puff you skip is a win. Your body starts healing within 20 minutes of your last hit.',
      'Nicotine cravings peak at 3-5 minutes. Distract yourself and they pass.',
      'A JUUL pod has as much nicotine as 20 cigarettes. Each puff down is progress.',
      'Your lungs start clearing mucus within 72 hours of reducing intake.',
      'Vaping can deliver heavy metals like lead directly to your lungs.',
      'Quitting saves the average vaper over $1,500 per year.',
      'Nicotine narrows your blood vessels, reducing oxygen to every organ.',
      'Your sense of taste and smell start improving within 48 hours.',
      'Exercise is one of the most effective craving-busters. Even a short walk helps.',
      'Vaping before bed disrupts deep sleep. Better sleep starts when you quit.',
      'Formaldehyde â€” yes, embalming fluid â€” is produced when vape juice is heated.',
      'Your heart rate begins normalizing just 20 minutes after your last puff.',
      'Diacetyl in vape flavors is linked to irreversible lung damage.',
      'Drinking water helps flush nicotine from your system faster.',
      'Stress relief from vaping is an illusion â€” nicotine actually increases anxiety long-term.'
    ];

    // â”€â”€ Notification messages â”€â”€
    const NOTIF_MESSAGES = [
      { title: 'How are you doing?', body: 'Tap to log a puff and stay on track.' },
      { title: 'Stay strong!', body: 'Every puff you skip is healing your body.' },
      { title: 'Check in time', body: 'Log your puffs to keep your streak going.' },
      { title: 'You\'re doing great', body: 'Tap to update your progress for today.' },
      { title: 'Quick check-in', body: 'How\'s your day going? Tap to log.' },
      { title: 'Keep it up!', body: 'Your lungs are thanking you. Tap to log.' },
      { title: 'Reminder', body: 'Don\'t forget to track â€” awareness is power.' }
    ];

    // â”€â”€ Onboarding total screens (0-20), main app = 21 â”€â”€
    const TOTAL_ONBOARDING_SCREENS = 21;

    // â”€â”€ App â”€â”€
    function App() {
      const saved = loadData();
      const [screen, setScreen] = useState(
        saved && saved.onboardingComplete ? TOTAL_ONBOARDING_SCREENS : 0
      );
      const [data, setData] = useState({
        userName: '',
        goals: [],
        longTermGoal: null,
        vapeType: null,
        dailyPuffs: 150,
        vapingDuration: null,
        weeklySpend: 30,
        lifeImpact: 3,
        triggers: [],
        biggestStruggle: null,
        quitAttempts: null,
        onboardingComplete: false,
        ...(saved || {})
      });

      useEffect(() => { saveData(data); }, [data]);

      const update = (key, val) => setData(prev => ({ ...prev, [key]: val }));
      const next = () => setScreen(s => s + 1);

      // Helper: toggle item in array (max items)
      const toggleArrayItem = (key, item, max) => {
        setData(prev => {
          const arr = prev[key] || [];
          if (arr.includes(item)) {
            return { ...prev, [key]: arr.filter(x => x !== item) };
          }
          if (arr.length >= max) return prev;
          return { ...prev, [key]: [...arr, item] };
        });
      };

      // Helper: display name or fallback
      const displayName = data.userName ? data.userName.split(' ')[0] : '';

      // â”€â”€ Progress bar helper â”€â”€
      function ProgressBar({ current, total }) {
        const pct = Math.round((current / total) * 100);
        return (
          <div className="progress-bar-container">
            <div className="progress-bar-fill" style={{ width: pct + '%' }} />
          </div>
        );
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // PHASE 1: PINPOINT THE PROBLEM (0-10)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      // â”€â”€ Screen 0: Welcome â”€â”€
      function WelcomeScreen() {
        return (
          <div className="screen" key="s0">
            <div className="spacer" />
            <div className="text-center mb-32">
              <div style={{ fontSize: 80, marginBottom: 24 }}>ğŸ«</div>
              <h1 style={{ fontSize: 28, fontWeight: 700, marginBottom: 12, lineHeight: 1.1 }}>
                Ready to quit vaping?
              </h1>
              <p className="text-muted" style={{ fontSize: 15, lineHeight: 1.4, marginBottom: 32 }}>
                Let's build a plan that actually works for you
              </p>
              <input
                className="name-input"
                type="text"
                placeholder="What's your name?"
                value={data.userName}
                onChange={e => update('userName', e.target.value)}
                autoFocus
              />
            </div>
            <div className="spacer" />
            <button className="btn btn-primary" onClick={next} disabled={!data.userName.trim()}>
              Let's Go
            </button>
          </div>
        );
      }

      // â”€â”€ Screen 1: Goals (multi-select, up to 3) â”€â”€
      function GoalsScreen() {
        const options = [
          'Breathe easier', 'Save money', 'Break the addiction', 'Mental clarity',
          'Better fitness', 'Improve relationships', 'Feel in control', 'Better sleep'
        ];
        return (
          <div className="screen" key="s1">
            <ProgressBar current={1} total={20} />
            <h2 style={{ fontSize: 22, fontWeight: 600, marginBottom: 6 }}>What do you want to achieve?</h2>
            <p className="text-muted mb-24" style={{ fontSize: 14 }}>
              So tell us {displayName}, what matters most? <span style={{ color: 'var(--dark-grey)', fontSize: 12 }}>(pick up to 3)</span>
            </p>
            <div className="multi-select-grid mb-24">
              {options.map(opt => (
                <div
                  key={opt}
                  className={`multi-select-card ${(data.goals || []).includes(opt) ? 'selected' : ''}`}
                  onClick={() => toggleArrayItem('goals', opt, 3)}
                >
                  <div className="ms-check">âœ“</div>
                  <span className="emoji">{GOAL_EMOJIS[opt]}</span>
                  <span className="label">{opt}</span>
                </div>
              ))}
            </div>
            <div className="spacer" />
            <button className="btn btn-primary" onClick={next} disabled={!(data.goals && data.goals.length > 0)}>
              Continue
            </button>
          </div>
        );
      }

      // â”€â”€ Screen 2: Long-term goal (single select) â”€â”€
      function LongTermGoalScreen() {
        const options = [
          { key: 'quit', label: 'Quit vaping completely', emoji: 'ğŸš«' },
          { key: 'cut_down', label: 'Cut down significantly', emoji: 'ğŸ“‰' },
          { key: '30_day_break', label: 'Take a 30-day break', emoji: 'ğŸ“…' },
          { key: 'track', label: 'Just track and see', emoji: 'ğŸ“Š' }
        ];
        return (
          <div className="screen" key="s2">
            <ProgressBar current={2} total={20} />
            <h2 style={{ fontSize: 22, fontWeight: 600, marginBottom: 6 }}>What's your long-term goal?</h2>
            <p className="text-muted mb-24" style={{ fontSize: 14 }}>
              Got it {displayName}! Now where do you see yourself headed?
            </p>
            <div className="option-stack mb-32">
              {options.map(o => (
                <div
                  key={o.key}
                  className={`option-card ${data.longTermGoal === o.key ? 'selected' : ''}`}
                  onClick={() => update('longTermGoal', o.key)}
                >
                  <span className="emoji">{o.emoji}</span>
                  <span className="label">{o.label}</span>
                </div>
              ))}
            </div>
            <div className="spacer" />
            <button className="btn btn-primary" onClick={next} disabled={!data.longTermGoal}>
              Continue
            </button>
          </div>
        );
      }

      // â”€â”€ Screen 3: Vape Type â”€â”€
      function VapeTypeScreen() {
        const types = [
          { key: 'disposable', emoji: 'ğŸŒ€', label: 'Disposable' },
          { key: 'pod', emoji: 'ğŸ’¨', label: 'Pod System' },
          { key: 'mod', emoji: 'ğŸ”‹', label: 'Box Mod' },
          { key: 'multiple', emoji: 'ğŸ”€', label: 'Multiple Devices' }
        ];
        return (
          <div className="screen" key="s3">
            <ProgressBar current={3} total={20} />
            <h2 style={{ fontSize: 22, fontWeight: 600, marginBottom: 6 }}>What do you vape?</h2>
            <p className="text-muted mb-24" style={{ fontSize: 14 }}>This helps us understand your usage pattern.</p>
            <div className="option-grid mb-32">
              {types.map(t => (
                <div
                  key={t.key}
                  className={`option-card ${data.vapeType === t.key ? 'selected' : ''}`}
                  onClick={() => update('vapeType', t.key)}
                >
                  <span className="emoji">{t.emoji}</span>
                  <span className="label">{t.label}</span>
                </div>
              ))}
            </div>
            <div className="spacer" />
            <button className="btn btn-primary" onClick={next} disabled={!data.vapeType}>
              Continue
            </button>
          </div>
        );
      }

      // â”€â”€ Screen 4: Daily Puffs (slider) â”€â”€
      function DailyPuffsScreen() {
        return (
          <div className="screen" key="s4">
            <ProgressBar current={4} total={20} />
            <h2 style={{ fontSize: 22, fontWeight: 600, marginBottom: 6 }}>How many puffs per day?</h2>
            <p className="text-muted mb-32" style={{ fontSize: 14 }}>Now, let's understand your use a bit more.</p>
            <div className="text-center mb-16">
              <span style={{ fontSize: 56, fontWeight: 700, color: 'var(--primary)' }}>
                {data.dailyPuffs}
              </span>
              <br />
              <span className="text-muted" style={{ fontSize: 15 }}>puffs per day</span>
            </div>
            <input
              type="range"
              min={10} max={500} step={10}
              value={data.dailyPuffs}
              onChange={e => update('dailyPuffs', Number(e.target.value))}
            />
            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 16 }}>
              <span className="text-muted" style={{ fontSize: 13 }}>10</span>
              <span className="text-muted" style={{ fontSize: 13 }}>500</span>
            </div>
            <p className="text-muted text-center mb-32" style={{ fontSize: 13 }}>
              {data.dailyPuffs < 50 ? 'Light use â€” great starting point' :
               data.dailyPuffs < 150 ? 'Moderate use â€” very manageable' :
               data.dailyPuffs < 300 ? 'Heavy use â€” we\'ve helped thousands like you' :
               'Very heavy use â€” your plan will be extra gradual'}
            </p>
            <div className="spacer" />
            <button className="btn btn-primary" onClick={next}>Continue</button>
          </div>
        );
      }

      // â”€â”€ Screen 5: Vaping Duration (single select) â”€â”€
      function VapingDurationScreen() {
        const options = [
          { key: 'under_6mo', label: 'Less than 6 months', emoji: 'ğŸŒ±' },
          { key: '6_12mo', label: '6â€“12 months', emoji: 'ğŸ“…' },
          { key: '1_2yr', label: '1â€“2 years', emoji: 'â³' },
          { key: '2_5yr', label: '2â€“5 years', emoji: 'ğŸ“†' },
          { key: '5plus', label: '5+ years', emoji: 'ğŸ”’' }
        ];
        return (
          <div className="screen" key="s5">
            <ProgressBar current={5} total={20} />
            <h2 style={{ fontSize: 22, fontWeight: 600, marginBottom: 6 }}>How long have you been vaping?</h2>
            <p className="text-muted mb-24" style={{ fontSize: 14 }}>This helps us tailor your quit timeline.</p>
            <div className="option-stack mb-32">
              {options.map(o => (
                <div
                  key={o.key}
                  className={`option-card ${data.vapingDuration === o.key ? 'selected' : ''}`}
                  onClick={() => update('vapingDuration', o.key)}
                >
                  <span className="emoji">{o.emoji}</span>
                  <span className="label">{o.label}</span>
                </div>
              ))}
            </div>
            <div className="spacer" />
            <button className="btn btn-primary" onClick={next} disabled={!data.vapingDuration}>
              Continue
            </button>
          </div>
        );
      }

      // â”€â”€ Screen 6: Spend (slider with period toggle) â”€â”€
      function WeeklySpendScreen() {
        const [period, setPeriod] = useState(data.spendPeriod || 'every2weeks');
        const spend = typeof data.weeklySpend === 'number' ? data.weeklySpend : 30;

        const periodConfig = {
          week: { label: 'Weekly', min: 5, max: 100, step: 5, toWeekly: v => v },
          every2weeks: { label: 'Every 2 weeks', min: 10, max: 150, step: 5, toWeekly: v => Math.round(v / 2) },
          month: { label: 'Monthly', min: 15, max: 300, step: 5, toWeekly: v => Math.round(v / 4.33) }
        };
        const cfg = periodConfig[period];
        const rawSpend = data.spendRaw || (period === 'every2weeks' ? spend * 2 : period === 'month' ? Math.round(spend * 4.33) : spend);
        const weeklyCalc = cfg.toWeekly(rawSpend);
        const clampedRaw = Math.max(cfg.min, Math.min(cfg.max, rawSpend));

        const handlePeriodChange = (newPeriod) => {
          setPeriod(newPeriod);
          update('spendPeriod', newPeriod);
          // Reset raw spend to a reasonable default for the new period
          const defaults = { week: 25, every2weeks: 40, month: 100 };
          const newRaw = defaults[newPeriod];
          setData(prev => ({ ...prev, spendRaw: newRaw, weeklySpend: periodConfig[newPeriod].toWeekly(newRaw) }));
        };

        const handleSlide = (val) => {
          const num = Number(val);
          setData(prev => ({ ...prev, spendRaw: num, weeklySpend: cfg.toWeekly(num) }));
        };

        return (
          <div className="screen" key="s6">
            <ProgressBar current={6} total={20} />
            <h2 style={{ fontSize: 22, fontWeight: 600, marginBottom: 6 }}>How much do you spend on vaping?</h2>
            <p className="text-muted mb-24" style={{ fontSize: 14 }}>We use this to calculate your savings.</p>

            <div style={{ display: 'flex', gap: 8, marginBottom: 24 }}>
              {Object.entries(periodConfig).map(([key, val]) => (
                <button
                  key={key}
                  onClick={() => handlePeriodChange(key)}
                  style={{
                    flex: 1, padding: '10px 4px', borderRadius: 12,
                    border: period === key ? '2px solid var(--primary)' : '1.5px solid var(--card-border)',
                    background: period === key ? 'var(--primary-dim)' : 'var(--card)',
                    color: period === key ? 'var(--primary)' : 'var(--subtext)',
                    fontSize: 13, fontWeight: 600, fontFamily: 'inherit', cursor: 'pointer'
                  }}
                >{val.label}</button>
              ))}
            </div>

            <div className="text-center mb-16">
              <span style={{ fontSize: 56, fontWeight: 700, color: 'var(--gold)' }}>
                ${clampedRaw}
              </span>
              <br />
              <span className="text-muted" style={{ fontSize: 15 }}>
                {period === 'week' ? 'per week' : period === 'every2weeks' ? 'every 2 weeks' : 'per month'}
              </span>
            </div>
            <input
              type="range"
              min={cfg.min} max={cfg.max} step={cfg.step}
              value={clampedRaw}
              onChange={e => handleSlide(e.target.value)}
            />
            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 16 }}>
              <span className="text-muted" style={{ fontSize: 13 }}>${cfg.min}</span>
              <span className="text-muted" style={{ fontSize: 13 }}>${cfg.max}</span>
            </div>
            <p className="text-muted text-center mb-32" style={{ fontSize: 13 }}>
              That's <span style={{ color: 'var(--gold)', fontWeight: 600 }}>${weeklyCalc * 52}</span> per year
            </p>
            <div className="spacer" />
            <button className="btn btn-primary" onClick={next}>Continue</button>
          </div>
        );
      }

      // â”€â”€ Screen 7: Life Impact (emoji slider) â”€â”€
      function LifeImpactScreen() {
        const faces = ['ğŸ˜«', 'ğŸ˜Ÿ', 'ğŸ˜', 'ğŸ™‚', 'ğŸ˜„'];
        const labels = ['Seriously harming', 'Somewhat harming', 'Neutral', 'Somewhat helping', 'Helping'];
        const impact = data.lifeImpact || 3;
        return (
          <div className="screen" key="s7">
            <ProgressBar current={7} total={20} />
            <h2 style={{ fontSize: 22, fontWeight: 600, marginBottom: 6 }}>How is vaping affecting your life?</h2>
            <p className="text-muted mb-32" style={{ fontSize: 14 }}>Be honest â€” there's no wrong answer.</p>
            <div className="text-center mb-16">
              <div className="emoji-slider-face" key={impact}
                style={{ animation: 'popIn 0.3s ease-out' }}>
                {faces[impact - 1]}
              </div>
              <p style={{ fontSize: 16, fontWeight: 500, marginTop: 8, color: impact <= 2 ? 'var(--coral)' : impact >= 4 ? 'var(--mint)' : 'var(--subtext)' }}>
                {labels[impact - 1]}
              </p>
            </div>
            <input
              type="range"
              min={1} max={5} step={1}
              value={impact}
              onChange={e => update('lifeImpact', Number(e.target.value))}
              style={{
                background: `linear-gradient(90deg, var(--coral) 0%, var(--gold) 50%, var(--mint) 100%)`
              }}
            />
            <div className="emoji-slider-labels mb-32">
              <span>Harming</span>
              <span>Helping</span>
            </div>
            <div className="spacer" />
            <button className="btn btn-primary" onClick={next}>Continue</button>
          </div>
        );
      }

      // â”€â”€ Screen 8: Triggers (multi-select, up to 3) â”€â”€
      function TriggersScreen() {
        const options = [
          { label: 'First thing in the morning', emoji: 'ğŸŒ…' },
          { label: 'After meals', emoji: 'ğŸ½ï¸' },
          { label: 'When stressed', emoji: 'ğŸ˜°' },
          { label: 'When bored', emoji: 'ğŸ˜‘' },
          { label: 'While driving', emoji: 'ğŸš—' },
          { label: 'Social situations', emoji: 'ğŸ‘¥' },
          { label: 'Before bed', emoji: 'ğŸŒ™' },
          { label: 'While working', emoji: 'ğŸ’»' }
        ];
        return (
          <div className="screen" key="s8">
            <ProgressBar current={8} total={20} />
            <h2 style={{ fontSize: 22, fontWeight: 600, marginBottom: 6 }}>When do you vape most?</h2>
            <p className="text-muted mb-24" style={{ fontSize: 14 }}>
              To help us create a plan for when temptations arise. <span style={{ color: 'var(--dark-grey)', fontSize: 12 }}>(pick up to 3)</span>
            </p>
            <div className="multi-select-grid mb-24">
              {options.map(o => (
                <div
                  key={o.label}
                  className={`multi-select-card ${(data.triggers || []).includes(o.label) ? 'selected' : ''}`}
                  onClick={() => toggleArrayItem('triggers', o.label, 3)}
                >
                  <div className="ms-check">âœ“</div>
                  <span className="emoji">{o.emoji}</span>
                  <span className="label">{o.label}</span>
                </div>
              ))}
            </div>
            <div className="spacer" />
            <button className="btn btn-primary" onClick={next} disabled={!(data.triggers && data.triggers.length > 0)}>
              Continue
            </button>
          </div>
        );
      }

      // â”€â”€ Screen 9: Biggest Struggle â”€â”€
      function BiggestStruggleScreen() {
        const options = [
          { key: 'cravings', label: 'Cravings are intense', emoji: 'ğŸ§ ' },
          { key: 'habit', label: 'It\'s just a habit', emoji: 'ğŸ”' },
          { key: 'social', label: 'Social pressure', emoji: 'ğŸ‘¥' },
          { key: 'stress', label: 'Stress relief', emoji: 'ğŸ˜¤' }
        ];
        return (
          <div className="screen" key="s9">
            <ProgressBar current={9} total={20} />
            <h2 style={{ fontSize: 22, fontWeight: 600, marginBottom: 6 }}>What's your biggest struggle?</h2>
            <p className="text-muted mb-24" style={{ fontSize: 14 }}>Understanding this helps us support you better.</p>
            <div className="option-stack mb-32">
              {options.map(o => (
                <div
                  key={o.key}
                  className={`option-card ${data.biggestStruggle === o.key ? 'selected' : ''}`}
                  onClick={() => update('biggestStruggle', o.key)}
                >
                  <span className="emoji">{o.emoji}</span>
                  <span className="label">{o.label}</span>
                </div>
              ))}
            </div>
            <div className="spacer" />
            <button className="btn btn-primary" onClick={next} disabled={!data.biggestStruggle}>
              Continue
            </button>
          </div>
        );
      }

      // â”€â”€ Screen 10: Quit Attempts â”€â”€
      function QuitAttemptsScreen() {
        const options = [
          { key: 'many', label: 'Yes, many times', emoji: 'ğŸ”„' },
          { key: 'few', label: 'Yes, once or twice', emoji: 'âœŒï¸' },
          { key: 'first', label: 'No, this is my first try', emoji: 'ğŸŒŸ' }
        ];
        return (
          <div className="screen" key="s10">
            <ProgressBar current={10} total={20} />
            <h2 style={{ fontSize: 22, fontWeight: 600, marginBottom: 6 }}>Have you tried to quit before?</h2>
            <p className="text-muted mb-24" style={{ fontSize: 14 }}>This helps us build on what you already know.</p>
            <div className="option-stack mb-32">
              {options.map(o => (
                <div
                  key={o.key}
                  className={`option-card ${data.quitAttempts === o.key ? 'selected' : ''}`}
                  onClick={() => update('quitAttempts', o.key)}
                >
                  <span className="emoji">{o.emoji}</span>
                  <span className="label">{o.label}</span>
                </div>
              ))}
            </div>
            <div className="spacer" />
            <button className="btn btn-primary" onClick={next} disabled={!data.quitAttempts}>
              Continue
            </button>
          </div>
        );
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // PHASE 2: SHOW THE SOLUTION (11-15)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      // â”€â”€ Screen 11: Transition â”€â”€
      function TransitionScreen() {
        return (
          <div className="screen screen-gradient" key="s11">
            <div className="spacer" />
            <div className="text-center mb-32" style={{ animation: 'fadeInUp 0.5s ease-out' }}>
              <div style={{ fontSize: 64, marginBottom: 24 }}>âœ¨</div>
              <h2 style={{ fontSize: 26, fontWeight: 700, marginBottom: 12, lineHeight: 1.2 }}>
                Thanks {displayName}!
              </h2>
              <p className="text-muted" style={{ fontSize: 16, lineHeight: 1.5 }}>
                Based on thousands of vapers, here's where you're at
              </p>
            </div>
            <div className="spacer" />
            <button className="btn btn-primary" onClick={next}>Show Me</button>
          </div>
        );
      }

      // â”€â”€ Screen 12: Personalized Snapshot â”€â”€
      function SnapshotScreen() {
        const weeklySpendNum = getWeeklySpendNum(data.weeklySpend);
        const yearlySpend = Math.round(weeklySpendNum * 52);

        // Nicotine dependency: based on daily puffs + duration
        const durationMultiplier = {
          'under_6mo': 0.5, '6_12mo': 0.7, '1_2yr': 0.85, '2_5yr': 0.95, '5plus': 1.0
        };
        const durMult = durationMultiplier[data.vapingDuration] || 0.7;
        const puffScore = Math.min(data.dailyPuffs / 500, 1);
        const nicotineDep = Math.round((puffScore * 0.6 + durMult * 0.4) * 100);

        // Habit strength: based on number of triggers + duration
        const triggerCount = (data.triggers || []).length;
        const habitStrength = Math.round((triggerCount / 3 * 0.5 + durMult * 0.5) * 100);

        const [show, setShow] = useState(false);
        useEffect(() => { const t = setTimeout(() => setShow(true), 300); return () => clearTimeout(t); }, []);

        return (
          <div className="screen" key="s12">
            <ProgressBar current={12} total={20} />
            <h2 style={{ fontSize: 22, fontWeight: 600, marginBottom: 6 }}>Your Vaping Snapshot</h2>
            <p className="text-muted mb-32" style={{ fontSize: 14 }}>Here's what your answers tell us, {displayName}.</p>

            <div className="card mb-24" style={{ padding: 20 }}>
              <div className="snapshot-bar-container">
                <div className="snapshot-bar-label">
                  <span className="bar-title">Nicotine Dependency</span>
                  <span className="bar-value" style={{ color: 'var(--coral)' }}>{nicotineDep}%</span>
                </div>
                <div className="snapshot-bar">
                  <div className="snapshot-bar-fill red" style={{ width: show ? nicotineDep + '%' : '0%' }} />
                </div>
              </div>

              <div className="snapshot-bar-container">
                <div className="snapshot-bar-label">
                  <span className="bar-title">Habit Strength</span>
                  <span className="bar-value" style={{ color: 'var(--gold)' }}>{habitStrength}%</span>
                </div>
                <div className="snapshot-bar">
                  <div className="snapshot-bar-fill orange" style={{ width: show ? habitStrength + '%' : '0%' }} />
                </div>
              </div>

              <div className="snapshot-bar-container" style={{ marginBottom: 0 }}>
                <div className="snapshot-bar-label">
                  <span className="bar-title">Financial Drain</span>
                  <span className="bar-value" style={{ color: 'var(--gold)' }}>${yearlySpend}/yr</span>
                </div>
                <p className="text-muted" style={{ fontSize: 13, marginTop: 4 }}>
                  You'll spend <span style={{ color: 'var(--gold)', fontWeight: 600 }}>${yearlySpend}</span> this year on vaping
                </p>
              </div>
            </div>

            <div className="spacer" />
            <button className="btn btn-primary" onClick={next}>Next</button>
          </div>
        );
      }

      // â”€â”€ Screen 13: Usage Comparison â”€â”€
      function ComparisonScreen() {
        const avgPuffs = 100; // Average baseline
        const userPuffs = data.dailyPuffs;
        const percentile = Math.min(Math.round((userPuffs / 400) * 100), 99);
        const othersWidth = Math.round((avgPuffs / Math.max(userPuffs, avgPuffs)) * 100);
        const youWidth = Math.round((userPuffs / Math.max(userPuffs, avgPuffs)) * 100);

        const [show, setShow] = useState(false);
        useEffect(() => { const t = setTimeout(() => setShow(true), 300); return () => clearTimeout(t); }, []);

        return (
          <div className="screen" key="s13">
            <ProgressBar current={13} total={20} />
            <h2 style={{ fontSize: 22, fontWeight: 600, marginBottom: 6 }}>Your Usage vs Others</h2>
            <p className="text-muted mb-32" style={{ fontSize: 14 }}>How your daily puffs compare to other vapers.</p>

            <div className="card mb-24" style={{ padding: 20 }}>
              <div className="comparison-bar-wrapper">
                <div className="comparison-bar-label">
                  <span style={{ color: 'var(--mint)' }}>Others</span>
                  <span className="text-muted" style={{ fontSize: 13 }}>~{avgPuffs} puffs/day</span>
                </div>
                <div className="comparison-bar-track">
                  <div className="comparison-bar-value green" style={{ width: show ? othersWidth + '%' : '0%' }}>
                    {avgPuffs}
                  </div>
                </div>
              </div>

              <div className="comparison-bar-wrapper" style={{ marginBottom: 0 }}>
                <div className="comparison-bar-label">
                  <span style={{ color: 'var(--coral)' }}>You</span>
                  <span className="text-muted" style={{ fontSize: 13 }}>{userPuffs} puffs/day</span>
                </div>
                <div className="comparison-bar-track">
                  <div className="comparison-bar-value red" style={{ width: show ? youWidth + '%' : '0%' }}>
                    {userPuffs}
                  </div>
                </div>
              </div>
            </div>

            <div className="text-center mb-32">
              <p style={{ fontSize: 16, fontWeight: 500, lineHeight: 1.4 }}>
                Your vaping is higher than <span style={{ color: 'var(--coral)', fontWeight: 700 }}>{percentile}%</span> of other people
              </p>
              {data.quitAttempts === 'many' && (
                <p className="text-muted" style={{ fontSize: 14, marginTop: 8 }}>
                  You've tried before â€” this time, you'll have a plan.
                </p>
              )}
              {data.quitAttempts === 'first' && (
                <p className="text-muted" style={{ fontSize: 14, marginTop: 8 }}>
                  Starting your first quit journey takes courage. We've got you.
                </p>
              )}
            </div>

            <div className="spacer" />
            <button className="btn btn-primary" onClick={next}>Next</button>
          </div>
        );
      }

      // â”€â”€ Screen 14: Goals + Solution â”€â”€
      function GoalsSolutionScreen() {
        const goalLabels = {
          quit: 'Quit completely',
          cut_down: 'Cut down significantly',
          '30_day_break': 'Take a 30-day break',
          track: 'Track and see'
        };
        return (
          <div className="screen" key="s14">
            <ProgressBar current={14} total={20} />
            <div className="spacer" style={{ flex: 0.2 }} />
            <div className="text-center mb-24">
              <h2 style={{ fontSize: 24, fontWeight: 700, marginBottom: 8, lineHeight: 1.2 }}>
                You're in the right place, {displayName}!
              </h2>
            </div>

            <div className="mb-24">
              <p className="text-muted mb-12" style={{ fontSize: 13, textTransform: 'uppercase', letterSpacing: 0.5, fontWeight: 600 }}>Your goals</p>
              <div style={{ display: 'flex', flexWrap: 'wrap', gap: 8 }}>
                {(data.goals || []).map(g => (
                  <div className="goal-chip" key={g}>
                    <span>{GOAL_EMOJIS[g]}</span>
                    <span>{g}</span>
                  </div>
                ))}
              </div>
            </div>

            <div className="card mb-24" style={{ padding: 16, borderColor: 'rgba(45,212,191,0.3)' }}>
              <p className="text-muted" style={{ fontSize: 12, textTransform: 'uppercase', letterSpacing: 0.5, fontWeight: 600, marginBottom: 4 }}>Your mission</p>
              <p style={{ fontSize: 17, fontWeight: 600 }}>
                {goalLabels[data.longTermGoal] || 'Quit vaping'}
              </p>
            </div>

            <div className="card mb-24" style={{ padding: 16, background: 'linear-gradient(135deg, rgba(45,212,191,0.06), rgba(134,239,172,0.06))', borderColor: 'rgba(134,239,172,0.2)' }}>
              <p style={{ fontSize: 14, color: 'var(--subtext)', lineHeight: 1.5, marginBottom: 8 }}>
                Thousands have started with the same goals, and PuffDown got them there.
              </p>
              <p style={{ fontSize: 13, color: 'var(--primary)', fontWeight: 600 }}>
                4.8 stars from 2,000+ users
              </p>
            </div>

            <div className="spacer" />
            <button className="btn btn-primary" onClick={next}>See My Plan</button>
          </div>
        );
      }

      // â”€â”€ Screen 15: Personalized Plan â”€â”€
      function PersonalPlanScreen() {
        const weeklySpendNum = getWeeklySpendNum(data.weeklySpend);
        const savingsTarget = Math.round(weeklySpendNum * 6.5);
        const quitDate = new Date();
        quitDate.setDate(quitDate.getDate() + 45);
        const quitDateStr = quitDate.toLocaleDateString('en-US', {
          month: 'long', day: 'numeric', year: 'numeric'
        });

        const animDays = useCountUp(45, 1500, 200);
        const animSavings = useCountUp(savingsTarget, 1500, 500);

        const topGoals = (data.goals || []).slice(0, 3);

        return (
          <div className="screen" key="s15">
            <ProgressBar current={15} total={20} />
            <div className="text-center mb-24">
              <h2 style={{ fontSize: 24, fontWeight: 700, marginBottom: 4, lineHeight: 1.1 }}>
                {displayName}'s PuffDown Plan
              </h2>
              <p className="text-muted" style={{ fontSize: 14 }}>45 days from now</p>
            </div>

            <div className="card mb-12" style={{ textAlign: 'center', padding: 20 }}>
              <p className="text-muted" style={{ fontSize: 13, marginBottom: 6, textTransform: 'uppercase', letterSpacing: 0.5, fontWeight: 500 }}>
                Your target
              </p>
              <p style={{ fontSize: 48, fontWeight: 700, color: 'var(--primary)' }}>
                {animDays} <span style={{ fontSize: 22, fontWeight: 600 }}>days</span>
              </p>
              <p className="text-muted" style={{ fontSize: 13, marginTop: 4 }}>
                {quitDateStr}
              </p>
            </div>

            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12, marginBottom: 20 }}>
              <div className="card" style={{ textAlign: 'center', padding: 14 }}>
                <p className="text-muted" style={{ fontSize: 11, marginBottom: 4, textTransform: 'uppercase', letterSpacing: 0.5, fontWeight: 500 }}>
                  You'll save
                </p>
                <p style={{ fontSize: 26, fontWeight: 700, color: 'var(--gold)' }}>
                  ${animSavings}
                </p>
              </div>
              {topGoals[0] && (
                <div className="card" style={{ textAlign: 'center', padding: 14 }}>
                  <p className="text-muted" style={{ fontSize: 11, marginBottom: 4, textTransform: 'uppercase', letterSpacing: 0.5, fontWeight: 500 }}>
                    Top goal
                  </p>
                  <p style={{ fontSize: 20, marginBottom: 2 }}>{GOAL_EMOJIS[topGoals[0]]}</p>
                  <p style={{ fontSize: 13, fontWeight: 500, color: 'var(--primary)' }}>{topGoals[0]}</p>
                </div>
              )}
            </div>

            <div className="card mb-24" style={{ padding: 16 }}>
              <p style={{ fontSize: 13, fontWeight: 600, textTransform: 'uppercase', letterSpacing: 0.5, color: 'var(--primary)', marginBottom: 12 }}>
                How we'll get you there
              </p>
              <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>
                <div className="step-item">
                  <div className="step-circle">1</div>
                  <div>
                    <p style={{ fontSize: 15, fontWeight: 500 }}>Track your puffs</p>
                    <p className="text-muted" style={{ fontSize: 13 }}>Build awareness of your patterns</p>
                  </div>
                </div>
                <div className="step-item">
                  <div className="step-circle">2</div>
                  <div>
                    <p style={{ fontSize: 15, fontWeight: 500 }}>Reduce gradually</p>
                    <p className="text-muted" style={{ fontSize: 13 }}>Daily limits that adapt to you</p>
                  </div>
                </div>
                <div className="step-item">
                  <div className="step-circle">3</div>
                  <div>
                    <p style={{ fontSize: 15, fontWeight: 500 }}>Hit your goals</p>
                    <p className="text-muted" style={{ fontSize: 13 }}>{topGoals.join(', ') || 'Quit for good'}</p>
                  </div>
                </div>
              </div>
            </div>

            <div className="spacer" />
            <button className="btn btn-primary mb-12" onClick={next}>Start my PuffDown</button>
            <div className="text-center">
              <button className="link-muted" onClick={() => {
                setData(prev => ({ ...prev, onboardingComplete: true, startDate: todayKey(), puffLogs: prev.puffLogs || {} }));
                setScreen(TOTAL_ONBOARDING_SCREENS);
              }}>I'm not ready yet</button>
            </div>
          </div>
        );
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // PHASE 3: WOW MOMENT (16)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      // â”€â”€ Screen 16: Interactive Day 1 Demo â”€â”€
      function WowMomentScreen() {
        const [demoPuffs, setDemoPuffs] = useState(0);
        const [tapped, setTapped] = useState(false);
        const todayStr = new Date().toLocaleDateString('en-US', {
          weekday: 'long', month: 'long', day: 'numeric'
        });
        const dailyTarget = Math.max(data.dailyPuffs - 10, 1);
        const circumference = 2 * Math.PI * 88;
        const progress = Math.min(demoPuffs / dailyTarget, 1);
        const offset = circumference * (1 - progress);

        const handleTap = () => {
          setDemoPuffs(p => p + 1);
          setTapped(true);
        };

        return (
          <div className="screen" key="s16">
            <div className="text-center mb-8">
              <p className="text-muted" style={{ fontSize: 13 }}>{todayStr}</p>
              <h2 style={{ fontSize: 28, fontWeight: 700, marginTop: 4, lineHeight: 1.1 }}>Day 1</h2>
            </div>

            <div style={{ height: 12 }} />

            <div className="progress-ring-container mb-24">
              <svg viewBox="0 0 200 200">
                <circle className="progress-ring-bg" cx="100" cy="100" r="88" />
                <circle
                  className="progress-ring-fill"
                  cx="100" cy="100" r="88"
                  strokeDasharray={circumference}
                  strokeDashoffset={offset}
                />
              </svg>
              <div className="progress-ring-text">
                <span style={{
                  fontSize: 48, fontWeight: 700,
                  animation: demoPuffs > 0 ? 'countPulse 0.3s ease' : 'none'
                }} key={demoPuffs}>{demoPuffs}</span>
                <span className="text-muted" style={{ fontSize: 15 }}>/ {dailyTarget} puffs</span>
              </div>
            </div>

            <div className="stat-row mb-24">
              <div className="stat-box">
                <div className="stat-value" style={{ color: 'var(--primary)' }}>0</div>
                <div className="stat-label">Day Streak</div>
              </div>
              <div className="stat-box">
                <div className="stat-value" style={{ color: 'var(--gold)' }}>$0</div>
                <div className="stat-label">Saved</div>
              </div>
              <div className="stat-box">
                <div className="stat-value" style={{ color: 'var(--mint)' }}>ğŸ«</div>
                <div className="stat-label">Recovering</div>
              </div>
            </div>

            {!tapped && (
              <button className="btn btn-primary mb-16" onClick={handleTap}
                style={{ animation: 'countPulse 2s ease-in-out infinite' }}>
                Tap to log your first puff
              </button>
            )}

            {tapped && (
              <div style={{ animation: 'fadeInUp 0.4s ease-out' }}>
                <div className="card mb-16" style={{ padding: 16, borderColor: 'rgba(45,212,191,0.3)', textAlign: 'center' }}>
                  <p style={{ fontSize: 15, lineHeight: 1.5 }}>
                    This is how easy it is. Every puff you track brings you closer to quitting.
                  </p>
                </div>
                <button className="btn btn-primary" onClick={next}>I'm Ready</button>
              </div>
            )}

            {tapped && (
              <button className="btn btn-outline mb-12" onClick={handleTap} style={{ marginTop: 8 }}>
                + Log another puff
              </button>
            )}

            <div className="spacer" />
          </div>
        );
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // PHASE 4: SOFT PAYWALL (17-19)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      // â”€â”€ Screen 17: Paywall Step 1 (Features) â”€â”€
      function PaywallStep1Screen() {
        const features = [
          { title: 'Smart puff tracking', desc: 'Auto-adjusting daily limits that adapt to you' },
          { title: 'Progress insights', desc: 'Health recovery timeline, savings tracker & streaks' },
          { title: 'Craving support', desc: 'Techniques and tools when urges hit' }
        ];
        return (
          <div className="screen" key="s17">
            <div className="spacer" style={{ flex: 0.3 }} />
            <div className="text-center mb-32">
              <h2 style={{ fontSize: 26, fontWeight: 700, marginBottom: 8, lineHeight: 1.1 }}>
                Your plan is ready.<br />Unlock it all.
              </h2>
            </div>
            <div className="card mb-32" style={{ padding: '4px 16px' }}>
              {features.map((f, i) => (
                <div className="feature-row" key={i}>
                  <div className="feature-check">âœ“</div>
                  <div>
                    <p style={{ fontSize: 15, fontWeight: 500, marginBottom: 2 }}>{f.title}</p>
                    <p className="text-muted" style={{ fontSize: 13 }}>{f.desc}</p>
                  </div>
                </div>
              ))}
            </div>
            <div className="spacer" />
            <button className="btn btn-primary" onClick={next}>Continue</button>
          </div>
        );
      }

      // â”€â”€ Screen 18: Paywall Step 2 (Trust) â”€â”€
      function PaywallStep2Screen() {
        return (
          <div className="screen" key="s18">
            <div className="spacer" />
            <div className="text-center">
              <div style={{
                width: 80, height: 80, borderRadius: '50%',
                background: 'var(--primary-dim)',
                display: 'flex', alignItems: 'center', justifyContent: 'center',
                margin: '0 auto 24px', fontSize: 36
              }}>ğŸ””</div>
              <h2 style={{ fontSize: 22, fontWeight: 600, marginBottom: 12, lineHeight: 1.3 }}>
                We'll remind you before your trial ends
              </h2>
              <p className="text-muted mb-32" style={{ fontSize: 15, lineHeight: 1.4 }}>
                You won't be charged today. Start your 7-day free trial and cancel anytime â€” we'll send a reminder 24 hours before it renews.
              </p>
              <p style={{ fontSize: 14, color: 'var(--mint)', fontWeight: 600 }}>No Payment Due Now</p>
            </div>
            <div className="spacer" />
            <button className="btn btn-primary" onClick={next}>Continue for FREE</button>
          </div>
        );
      }

      // â”€â”€ Screen 19: Paywall Step 3 (Pricing â€” soft) â”€â”€
      function PaywallStep3Screen() {
        const [selectedPlan, setSelectedPlan] = useState('monthly');

        const finishOnboarding = () => {
          setData(prev => ({
            ...prev,
            onboardingComplete: true,
            startDate: prev.startDate || todayKey(),
            puffLogs: prev.puffLogs || {}
          }));
          setScreen(20); // Go to notification screen
        };

        return (
          <div className="screen" key="s19">
            <div className="spacer" style={{ flex: 0.2 }} />
            <div className="text-center mb-24">
              <h2 style={{ fontSize: 28, fontWeight: 700, marginBottom: 8, lineHeight: 1.1 }}>Choose your plan</h2>
              <p className="text-muted" style={{ fontSize: 15 }}>Start with a 7-day free trial</p>
            </div>

            <div style={{ display: 'flex', flexDirection: 'column', gap: 12, marginBottom: 24 }}>
              <div
                className={`pricing-card ${selectedPlan === 'weekly' ? 'selected' : ''}`}
                onClick={() => setSelectedPlan('weekly')}
              >
                <p className="plan-name">Weekly</p>
                <p className="plan-price">$4.99<span className="plan-period"> / week</span></p>
              </div>

              <div
                className={`pricing-card ${selectedPlan === 'monthly' ? 'selected' : ''}`}
                onClick={() => setSelectedPlan('monthly')}
                style={{ marginTop: 4 }}
              >
                <div className="badge">Most Popular</div>
                <p className="plan-name">Monthly</p>
                <p className="plan-price">$9.99<span className="plan-period"> / month</span></p>
              </div>

              <div
                className={`pricing-card ${selectedPlan === 'yearly' ? 'selected' : ''}`}
                onClick={() => setSelectedPlan('yearly')}
              >
                <div className="badge badge-gold">Best Value</div>
                <p className="plan-name">Yearly</p>
                <p className="plan-price">$29.99<span className="plan-period"> / year</span></p>
              </div>
            </div>

            <button className="btn btn-primary mb-16" onClick={finishOnboarding}>
              Start Free Trial
            </button>

            <div className="text-center mb-12">
              <button className="link-muted" onClick={finishOnboarding} style={{ fontSize: 14 }}>Maybe later</button>
            </div>
            <div className="text-center">
              <button className="link-muted" style={{ fontSize: 12 }}>Restore Purchases</button>
            </div>
            <div className="spacer" />
          </div>
        );
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // SCREEN 20: NOTIFICATION PERMISSION
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      function NotificationScreen() {
        const handleEnable = () => {
          if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
          }
          setScreen(TOTAL_ONBOARDING_SCREENS);
        };

        return (
          <div className="screen" key="s20">
            <div className="spacer" style={{ flex: 0.3 }} />
            <div className="text-center mb-32">
              <div style={{
                width: 80, height: 80, borderRadius: '50%',
                background: 'var(--primary-dim)',
                display: 'flex', alignItems: 'center', justifyContent: 'center',
                margin: '0 auto 24px', fontSize: 36
              }}>ğŸ””</div>
              <h2 style={{ fontSize: 24, fontWeight: 700, marginBottom: 8, lineHeight: 1.2 }}>
                Reach your goals with notifications
              </h2>
              <p className="text-muted" style={{ fontSize: 15, lineHeight: 1.4 }}>
                PuffDown uses daily reminders to keep you on track
              </p>
            </div>

            <div className="mock-notif mb-24">
              <div className="mock-notif-icon">ğŸ«</div>
              <div>
                <p className="mock-notif-title">PuffDown</p>
                <p className="mock-notif-body">How's your day going? Tap to log and stay on track.</p>
              </div>
              <span className="mock-notif-time">now</span>
            </div>

            <div className="text-center mb-32">
              <p style={{ fontSize: 14, color: 'var(--primary)', fontWeight: 500 }}>
                Users who enable notifications are 80% more likely to succeed
              </p>
            </div>

            <div className="spacer" />
            <button className="btn btn-primary mb-12" onClick={handleEnable}>Enable Notifications</button>
            <div className="text-center">
              <button className="link-muted" onClick={() => setScreen(TOTAL_ONBOARDING_SCREENS)}>
                Not now
              </button>
            </div>
          </div>
        );
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // HELPERS
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      function todayKey() {
        const d = new Date();
        return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
      }

      function daysSince(dateStr) {
        if (!dateStr) return 0;
        const start = new Date(dateStr + 'T00:00:00');
        const now = new Date();
        now.setHours(0, 0, 0, 0);
        return Math.max(0, Math.floor((now - start) / 86400000));
      }

      function calcStreak(puffLogs, dailyPuffs, startDate) {
        if (!startDate) return 0;
        let streak = 0;
        const now = new Date();
        now.setHours(0, 0, 0, 0);
        const check = new Date(now);
        check.setDate(check.getDate() - 1);
        const start = new Date(startDate + 'T00:00:00');
        while (check >= start) {
          const key = check.getFullYear() + '-' + String(check.getMonth() + 1).padStart(2, '0') + '-' + String(check.getDate()).padStart(2, '0');
          const elapsed = Math.floor((check - start) / 86400000);
          const target = Math.max(dailyPuffs - (10 * (elapsed + 1) / 45), 0);
          const logged = (puffLogs && puffLogs[key]) || 0;
          if (logged <= Math.ceil(target)) {
            streak++;
          } else {
            break;
          }
          check.setDate(check.getDate() - 1);
        }
        return streak;
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // MAIN APP (Screen 21)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      function MainApp() {
        const [activeTab, setActiveTab] = useState('dashboard');
        const startDate = data.startDate || todayKey();
        const puffLogs = data.puffLogs || {};
        const today = todayKey();
        const puffsToday = puffLogs[today] || 0;
        const elapsed = daysSince(startDate);
        const dailyTarget = Math.max(Math.round(data.dailyPuffs - (10 * (elapsed + 1) / 45)), 1);
        const circumference = 2 * Math.PI * 88;
        const progress = Math.min(puffsToday / dailyTarget, 1);
        const offset = circumference * (1 - progress);
        const overLimit = puffsToday > dailyTarget;

        const todayStr = new Date().toLocaleDateString('en-US', {
          weekday: 'long', month: 'long', day: 'numeric'
        });

        useEffect(() => {
          if (!data.startDate) {
            update('startDate', todayKey());
          }
        }, []);

        const streak = calcStreak(puffLogs, data.dailyPuffs, startDate);

        // Savings: puffs avoided * cost per puff (handles both old string and new number format)
        const weeklyMid = getWeeklySpendNum(data.weeklySpend);
        const costPerPuff = weeklyMid / 7 / data.dailyPuffs;
        let totalPuffsAvoided = 0;
        for (let i = 0; i <= elapsed; i++) {
          const d = new Date(startDate + 'T00:00:00');
          d.setDate(d.getDate() + i);
          const key = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
          const logged = puffLogs[key] || 0;
          const avoided = Math.max(data.dailyPuffs - logged, 0);
          totalPuffsAvoided += avoided;
        }
        const saved = Math.round(totalPuffsAvoided * costPerPuff * 100) / 100;

        const logPuff = useCallback(() => {
          setData(prev => {
            const logs = { ...prev.puffLogs } || {};
            logs[today] = (logs[today] || 0) + 1;
            return { ...prev, puffLogs: logs, startDate: prev.startDate || today };
          });
        }, [today]);

        // Auto-log from shortcut (?action=log)
        useEffect(() => {
          const params = new URLSearchParams(window.location.search);
          if (params.get('action') === 'log') {
            logPuff();
            window.history.replaceState({}, '', window.location.pathname);
          }
        }, [logPuff]);

        // Listen for LOG_PUFF postMessage from service worker
        useEffect(() => {
          const handler = (event) => {
            if (event.data && event.data.type === 'LOG_PUFF') {
              logPuff();
            }
          };
          navigator.serviceWorker && navigator.serviceWorker.addEventListener('message', handler);
          return () => {
            navigator.serviceWorker && navigator.serviceWorker.removeEventListener('message', handler);
          };
        }, [logPuff]);

        // Request notification permission for existing users (3s delay)
        useEffect(() => {
          if ('Notification' in window && Notification.permission === 'default') {
            const t = setTimeout(() => Notification.requestPermission(), 3000);
            return () => clearTimeout(t);
          }
        }, []);

        // Schedule reminder notifications every 2 hours
        useEffect(() => {
          if (!('Notification' in window) || Notification.permission !== 'granted') return;
          if (!navigator.serviceWorker || !navigator.serviceWorker.controller) return;

          const NOTIF_INTERVAL = 2 * 60 * 60 * 1000;
          const LAST_NOTIF_KEY = 'puffdown_last_notif';

          function scheduleNext() {
            const lastNotif = parseInt(localStorage.getItem(LAST_NOTIF_KEY) || '0', 10);
            const now = Date.now();
            const timeSinceLast = now - lastNotif;
            const delay = timeSinceLast >= NOTIF_INTERVAL ? 0 : NOTIF_INTERVAL - timeSinceLast;

            return setTimeout(async () => {
              try {
                const reg = await navigator.serviceWorker.ready;
                const msgIndex = Math.floor(Math.random() * NOTIF_MESSAGES.length);
                const msg = NOTIF_MESSAGES[msgIndex];
                await reg.showNotification(msg.title, {
                  body: msg.body,
                  icon: './icon-192.png',
                  badge: './icon-192.png',
                  tag: 'puffdown-reminder',
                  renotify: true
                });
                localStorage.setItem(LAST_NOTIF_KEY, String(Date.now()));
              } catch (e) {}
              timerId = scheduleNext();
            }, Math.max(delay, 60000));
          }

          let timerId = scheduleNext();
          return () => clearTimeout(timerId);
        }, []);

        const resetOnboarding = () => {
          const fresh = {
            userName: '', goals: [], longTermGoal: null,
            vapeType: null, dailyPuffs: 150, vapingDuration: null,
            weeklySpend: 30, lifeImpact: 3, triggers: [],
            biggestStruggle: null, quitAttempts: null,
            onboardingComplete: false
          };
          saveData(fresh);
          setData(fresh);
          setScreen(0);
        };

        const dayOfYear = Math.floor((Date.now() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
        const dailyFact = DAILY_FACTS[dayOfYear % DAILY_FACTS.length];

        const minutesSinceStart = startDate
          ? (Date.now() - new Date(startDate + 'T00:00:00').getTime()) / 60000
          : 0;

        const nextMilestoneIdx = HEALTH_TIMELINE.findIndex(m => m.minutes > minutesSinceStart);

        // â”€â”€ Dashboard Tab â”€â”€
        function DashboardTab() {
          return (
            <div className="tab-content">
              <div className="text-center mb-8">
                <p className="text-muted" style={{ fontSize: 13 }}>{todayStr}</p>
                <h2 style={{ fontSize: 28, fontWeight: 700, marginTop: 4, lineHeight: 1.1 }}>
                  {displayName ? `${displayName}'s Day ${elapsed + 1}` : `Day ${elapsed + 1}`}
                </h2>
              </div>

              <div style={{ height: 16 }} />

              <div className="progress-ring-container mb-24">
                <svg viewBox="0 0 200 200">
                  <circle className="progress-ring-bg" cx="100" cy="100" r="88" />
                  <circle
                    className="progress-ring-fill"
                    cx="100" cy="100" r="88"
                    strokeDasharray={circumference}
                    strokeDashoffset={offset}
                    style={overLimit ? { stroke: 'var(--coral)' } : {}}
                  />
                </svg>
                <div className="progress-ring-text">
                  <span style={{ fontSize: 48, fontWeight: 700, color: overLimit ? 'var(--coral)' : 'var(--text)' }}>{puffsToday}</span>
                  <span className="text-muted" style={{ fontSize: 15 }}>/ {dailyTarget} puffs</span>
                </div>
              </div>

              <div className="stat-row mb-24">
                <div className="stat-box">
                  <div className="stat-value" style={{ color: 'var(--primary)' }}>{streak}</div>
                  <div className="stat-label">Day Streak</div>
                </div>
                <div className="stat-box">
                  <div className="stat-value" style={{ color: 'var(--gold)' }}>${saved.toFixed(0)}</div>
                  <div className="stat-label">Saved</div>
                </div>
                <div className="stat-box">
                  <div className="stat-value" style={{ color: 'var(--mint)' }}>Day {elapsed + 1}</div>
                  <div className="stat-label">Journey</div>
                </div>
              </div>

              <button className="btn btn-primary mb-16" onClick={logPuff}>
                + Log a Puff
              </button>

              <div className="daily-fact mb-16">
                <p style={{ fontSize: 11, fontWeight: 600, color: 'var(--primary)', textTransform: 'uppercase', letterSpacing: 0.5, marginBottom: 6 }}>
                  Daily Fact
                </p>
                <p style={{ fontSize: 14, color: 'var(--subtext)', lineHeight: 1.5 }}>{dailyFact}</p>
              </div>

              <div className="text-center">
                <button className="link-muted" onClick={resetOnboarding} style={{ fontSize: 12 }}>
                  Reset Onboarding (dev)
                </button>
              </div>
              <div style={{ height: 16 }} />
            </div>
          );
        }

        // â”€â”€ Timeline Tab â”€â”€
        function TimelineTab() {
          return (
            <div className="tab-content">
              <div className="text-center mb-24">
                <h2 style={{ fontSize: 24, fontWeight: 700, lineHeight: 1.1 }}>Health Timeline</h2>
                <p className="text-muted" style={{ fontSize: 13, marginTop: 6 }}>
                  Your body is healing. Here's what's happening.
                </p>
              </div>
              {HEALTH_TIMELINE.map((milestone, i) => {
                const achieved = minutesSinceStart >= milestone.minutes;
                const isNext = i === nextMilestoneIdx;
                const status = achieved ? 'achieved' : isNext ? 'next' : 'future';
                return (
                  <div className={`milestone-card ${status}`} key={i}>
                    <div className="milestone-icon">{milestone.emoji}</div>
                    <div style={{ flex: 1 }}>
                      <p style={{ fontSize: 12, color: 'var(--subtext)', marginBottom: 2 }}>{milestone.time}</p>
                      <p style={{ fontSize: 15, fontWeight: 600, marginBottom: 4 }}>{milestone.title}</p>
                      <p style={{ fontSize: 13, color: 'var(--subtext)', lineHeight: 1.4 }}>{milestone.desc}</p>
                      {achieved && <span className="milestone-badge">Achieved</span>}
                      {isNext && <span className="milestone-badge">Next</span>}
                    </div>
                  </div>
                );
              })}
              <div style={{ height: 16 }} />
            </div>
          );
        }

        // â”€â”€ Learn Tab â”€â”€
        function LearnTab() {
          return (
            <div className="tab-content">
              <div className="text-center mb-24">
                <h2 style={{ fontSize: 24, fontWeight: 700, lineHeight: 1.1 }}>Learn</h2>
                <p className="text-muted" style={{ fontSize: 13, marginTop: 6 }}>
                  Knowledge is power. Understand what vaping does.
                </p>
              </div>
              {VAPE_FACTS.map((fact, i) => (
                <div className="fact-card" key={i}>
                  <span className="fact-emoji">{fact.emoji}</span>
                  <p className="fact-title">{fact.title}</p>
                  <p className="fact-body">{fact.body}</p>
                </div>
              ))}
              <div style={{ height: 16 }} />
            </div>
          );
        }

        return (
          <React.Fragment>
            <div className="screen-with-tabs" key="main">
              {activeTab === 'dashboard' && <DashboardTab />}
              {activeTab === 'timeline' && <TimelineTab />}
              {activeTab === 'learn' && <LearnTab />}
            </div>
            <div className="tab-bar">
              <button className={`tab-item ${activeTab === 'dashboard' ? 'active' : ''}`} onClick={() => setActiveTab('dashboard')}>
                <span className="tab-icon">ğŸ“Š</span>
                <span className="tab-label">Dashboard</span>
              </button>
              <button className={`tab-item ${activeTab === 'timeline' ? 'active' : ''}`} onClick={() => setActiveTab('timeline')}>
                <span className="tab-icon">â±ï¸</span>
                <span className="tab-label">Timeline</span>
              </button>
              <button className={`tab-item ${activeTab === 'learn' ? 'active' : ''}`} onClick={() => setActiveTab('learn')}>
                <span className="tab-icon">ğŸ“š</span>
                <span className="tab-label">Learn</span>
              </button>
            </div>
          </React.Fragment>
        );
      }

      // â”€â”€ Screen router â”€â”€
      const screens = [
        WelcomeScreen,         // 0  - Welcome + name
        GoalsScreen,           // 1  - Goals multi-select
        LongTermGoalScreen,    // 2  - Long-term goal
        VapeTypeScreen,        // 3  - Vape type
        DailyPuffsScreen,      // 4  - Daily puffs slider
        VapingDurationScreen,  // 5  - How long vaping
        WeeklySpendScreen,     // 6  - Weekly spend slider
        LifeImpactScreen,      // 7  - Emoji life impact slider
        TriggersScreen,        // 8  - Triggers multi-select
        BiggestStruggleScreen, // 9  - Biggest struggle
        QuitAttemptsScreen,    // 10 - Quit attempts
        TransitionScreen,      // 11 - Transition
        SnapshotScreen,        // 12 - Personalized snapshot
        ComparisonScreen,      // 13 - Usage comparison
        GoalsSolutionScreen,   // 14 - Goals + solution
        PersonalPlanScreen,    // 15 - Your plan
        WowMomentScreen,       // 16 - Interactive demo
        PaywallStep1Screen,    // 17 - Paywall features
        PaywallStep2Screen,    // 18 - Paywall trust
        PaywallStep3Screen,    // 19 - Paywall pricing
        NotificationScreen,    // 20 - Notification permission
        MainApp                // 21 - Main app
      ];

      const CurrentScreen = screens[screen] || MainApp;
      return <CurrentScreen />;
    }

    // â”€â”€ Mount â”€â”€
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);

    // â”€â”€ Register service worker â”€â”€
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js').catch(() => {});
    }
  </script>
</body>
</html>
